<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ULTRA Stock - Dashboard</title>
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay" style="display:none;">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
    </div>
  </div>

  <button class="mobile-menu-btn" onclick="toggleSidebar()">Menu</button>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="/images/logo.png" alt="ULTRA Stock" style="max-width: 100px; margin-bottom: 5px;">
        <div class="user-info">
          <div id="displayUsername">Loading...</div>
          <span class="user-role" id="displayRole">-</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a href="#" class="nav-link active" data-page="dashboard">
            <span class="icon">üìä</span> Dashboard
          </a>
          <a href="#" class="nav-link" data-page="buy">
            <span class="icon">üõí</span> ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="search" id="navSearchLink">
            <span class="icon">üîç</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="history">
            <span class="icon">üìã</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
          </a>
        </div>

        <div class="nav-section" id="navStockSection" style="display:none;">
          <div class="nav-section-title">Stock Management</div>
          <a href="#" class="nav-link" data-page="main-emails">
            <span class="icon">üìß</span> ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="stock">
            <span class="icon">üì¶</span> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="expiring">
            <span class="icon">‚è∞</span> ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
          </a>
        </div>

        <div class="nav-section" id="navCommissionSection" style="display:none;">
          <div class="nav-section-title">Commission</div>
          <a href="#" class="nav-link" data-page="my-commission">
            <span class="icon">üí∞</span> ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
          </a>
        </div>

        <div class="nav-section" id="navResellerSection" style="display:none;">
          <div class="nav-section-title">Reseller</div>
          <a href="#" class="nav-link" data-page="my-balance">
            <span class="icon">üí≥</span> ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á & ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
          </a>
        </div>

        <div class="nav-section" id="navAdminSection" style="display:none;">
          <div class="nav-section-title">Admin (Owner Only)</div>
          <a href="#" class="nav-link" data-page="admins">
            <span class="icon">üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          </a>
          <a href="#" class="nav-link" data-page="packages">
            <span class="icon">üì¶</span> ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à
          </a>
          <a href="#" class="nav-link" data-page="commissions">
            <span class="icon">üíµ</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
          </a>
          <a href="#" class="nav-link" data-page="all-commission">
            <span class="icon">üí∞</span> ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
          </a>
          <a href="#" class="nav-link" data-page="all-transactions">
            <span class="icon">üìë</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
          </a>
          <a href="#" class="nav-link" data-page="bank-settings">
            <span class="icon">üè¶</span> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£
          </a>
          <a href="#" class="nav-link" data-page="settings">
            <span class="icon">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="btn btn-secondary btn-block" onclick="logout()">
          Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div class="page" id="page-dashboard">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p id="dashboardSubtitle">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö ULTRA Stock</p>
        </div>

        <!-- Admin/Owner Stats (hidden for Customer/Reseller) -->
        <div class="stats-grid" id="statsGridAdmin" style="display:none;">
          <div class="stat-card primary">
            <div class="stat-icon">üî•</div>
            <div class="stat-value" id="statTodaySales">0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
          <div class="stat-card success">
            <div class="stat-icon">üìà</div>
            <div class="stat-value" id="statMonthSales">0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-value" id="statTotalSales">0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="statStock">0</div>
            <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-value" id="statExpiring">0</div>
            <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (7 ‡∏ß‡∏±‡∏ô)</div>
          </div>
        </div>

        <!-- Customer/Reseller Stats (their own data only) -->
        <div id="statsGridUser" style="display:none;">
          <div class="stats-grid">
            <div class="stat-card primary">
              <div class="stat-icon">üõí</div>
              <div class="stat-value" id="statUserTotalPurchases">0</div>
              <div class="stat-label">‡∏ã‡∏∑‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="stat-card success">
              <div class="stat-icon">‚úÖ</div>
              <div class="stat-value" id="statUserActive">0</div>
              <div class="stat-label">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</div>
            </div>
            <div class="stat-card danger">
              <div class="stat-icon">‚è∞</div>
              <div class="stat-value" id="statUserExpiring">0</div>
              <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
            </div>
          </div>

          <!-- Reseller Balance Card -->
          <div class="card mt-20" id="resellerBalanceCard" style="display:none;">
            <div class="card-header">
              <h3>üí≥ ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h3>
            </div>
            <div class="card-body">
              <div style="text-align:center;">
                <div style="font-size:2.5rem;font-weight:bold;color:var(--danger);" id="statResellerBalance">‡∏ø0</div>
                <p class="text-muted">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
                <a href="#" class="btn btn-primary" onclick="navigateTo('my-balance')">üì§ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ä‡∏≥‡∏£‡∏∞</a>
              </div>
            </div>
          </div>
        </div>

        <!-- My Stats (for Admin/Super Admin) -->
        <div class="card" id="myStatsCard" style="display:none;">
          <div class="card-header">
            <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="statMySales">0</div>
                <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
              </div>
              <div class="stat-card success">
                <div class="stat-value" id="statMyMonthSales">0</div>
                <div class="stat-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
              </div>
              <div class="stat-card" id="myCommissionCard">
                <div class="stat-value" id="statMyCommission">‡∏ø0</div>
                <div class="stat-label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Main Email Capacity (Owner/Super Admin only) -->
        <div class="card" id="mainEmailCapacityCard" style="display:none; margin-top: 20px;">
          <div class="card-header">
            <h3>üìß ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</h3>
            <button class="btn btn-sm btn-secondary" onclick="sendStockReport()">üì§ ‡∏™‡πà‡∏á Telegram</button>
          </div>
          <div class="card-body">
            <!-- Summary Stats -->
            <div class="stats-grid" style="margin-bottom:20px;">
              <div class="stat-card">
                <div class="stat-value" id="statTotalMain">0</div>
                <div class="stat-label">‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
              </div>
              <div class="stat-card danger">
                <div class="stat-value" id="statFullMain">0</div>
                <div class="stat-label">‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
              <div class="stat-card warning">
                <div class="stat-value" id="statTotalStock">0</div>
                <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏≠‡∏Ç‡∏≤‡∏¢</div>
              </div>
              <div class="stat-card success">
                <div class="stat-value" id="statAvailableSlots">0</div>
                <div class="stat-label">Slots ‡∏ß‡πà‡∏≤‡∏á</div>
              </div>
            </div>

            <!-- Main Email List -->
            <div id="mainEmailList">
              <!-- Dynamic content -->
            </div>
          </div>
        </div>
      </div>

      <!-- Buy Page -->
      <div class="page hidden" id="page-buy">
        <div class="page-header">
          <h2>üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
          <p>‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</p>
        </div>

        <div class="card" style="max-width: 500px;">
          <div class="card-body">
            <!-- Stock Available -->
            <div style="text-align:center; padding:20px; background:var(--dark); border-radius:12px; margin-bottom:20px;">
              <div style="font-size:0.9rem; color:var(--text-muted);">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</div>
              <div style="font-size:3rem; font-weight:bold; color:var(--success);" id="stockAvailable">0</div>
              <div style="font-size:0.85rem; color:var(--text-muted);">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <!-- Quantity -->
            <div class="form-group">
              <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
              <input type="number" class="form-control" id="buyQuantity" value="1" min="1" style="font-size:1.5rem; text-align:center; padding:15px;">
            </div>

            <!-- Package Selection -->
            <div class="form-group">
              <label>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</label>
              <div class="package-options" id="packageOptions">
                <!-- Dynamic -->
              </div>
            </div>

            <!-- Customer Name -->
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
              <input type="text" class="form-control" id="customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
            </div>

            <!-- Buy Buttons - Different for each role -->
            <div id="buyButtonsContainer" style="display:flex; gap:10px; margin-top:20px;">
              <!-- For Admin/Super Admin/Owner -->
              <div id="buyBtnAdmin" style="display:none; gap:10px; width:100%;">
                <button class="btn btn-primary" style="flex:1;" onclick="buyDirect()">
                  üõí ‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°)
                </button>
                <button class="btn btn-secondary" id="btnBuyStock" style="flex:1;" onclick="buyStock()">
                  üì¶ ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å
                </button>
              </div>
              <!-- For Reseller -->
              <div id="buyBtnReseller" style="display:none; flex:1;">
                <button class="btn btn-primary btn-block" onclick="buyDirect()">
                  üõí ‡∏ã‡∏∑‡πâ‡∏≠ (‡∏´‡∏±‡∏Å‡∏¢‡∏≠‡∏î)
                </button>
              </div>
              <!-- For Customer -->
              <div id="buyBtnCustomer" style="display:none; flex:1;">
                <button class="btn btn-success btn-block" onclick="customerBuy()">
                  üí≥ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô)
                </button>
              </div>
            </div>

            <!-- Price Summary -->
            <div id="priceSummary" style="margin-top:15px; padding:15px; background:var(--dark); border-radius:8px; text-align:center;">
              <span class="text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°:</span>
              <span id="totalPrice" style="font-size:1.5rem; font-weight:bold; color:var(--success); margin-left:10px;">‡∏ø0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Page -->
      <div class="page hidden" id="page-search">
        <div class="page-header">
          <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
          <p>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</p>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="search-box">
              <input type="text" class="form-control" id="searchEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
              <button class="btn btn-primary" onclick="searchSubEmail()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>

            <div id="searchResult" style="display:none;">
              <!-- Search result will appear here -->
            </div>
          </div>
        </div>
      </div>

      <!-- History Page -->
      <div class="page hidden" id="page-history">
        <div class="page-header">
          <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <select class="form-control" style="width:auto;" id="historyFilter" onchange="loadHistory()">
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <option value="direct">‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°)</option>
              <option value="stock">‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°)</option>
            </select>
          </div>
          <div class="card-body">
            <div id="historyList">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Emails Page -->
      <div class="page hidden" id="page-main-emails">
        <div class="page-header flex-between">
          <div>
            <h2>üìß ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</h2>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•‡∏´‡∏•‡∏±‡∏Å</p>
          </div>
          <button class="btn btn-primary" onclick="showAddMainEmailModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Password</th>
                    <th>Slots</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="mainEmailsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock Page -->
      <div class="page hidden" id="page-stock">
        <div class="page-header flex-between">
          <div>
            <h2>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
          </div>
          <button class="btn btn-primary" onclick="showAddStockModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>Password</th>
                    <th>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="stockTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Expiring Page -->
      <div class="page hidden" id="page-expiring">
        <div class="page-header">
          <h2>‚è∞ ‡πÄ‡∏°‡∏•‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</p>
        </div>

        <div id="expiringContent">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- My Commission Page -->
      <div class="page hidden" id="page-my-commission">
        <div class="page-header">
          <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <div class="card mb-20">
          <div class="card-header">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</h3>
            <select class="form-control" style="width:auto;" id="commissionMonth" onchange="loadMyCommission()">
              <!-- Dynamic months -->
            </select>
          </div>
          <div class="card-body">
            <!-- Enhanced stats grid -->
            <div class="stats-grid" style="grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));">
              <div class="stat-card success">
                <div class="stat-value" id="totalEarned">‡∏ø0</div>
                <div class="stat-label">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</div>
              </div>
              <div class="stat-card primary">
                <div class="stat-value" id="totalPaid">‡∏ø0</div>
                <div class="stat-label">‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
              <div class="stat-card warning">
                <div class="stat-value" id="totalUnpaid">‡∏ø0</div>
                <div class="stat-label">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
              </div>
              <div class="stat-card" style="background:linear-gradient(135deg, #9333ea, #7e22ce);">
                <div class="stat-value" id="totalBonus">‡∏ø0</div>
                <div class="stat-label">‡πÇ‡∏ö‡∏ô‡∏±‡∏™</div>
              </div>
            </div>

            <!-- Commission breakdown -->
            <div style="margin-top:20px;display:flex;gap:20px;flex-wrap:wrap;">
              <div style="flex:1;min-width:200px;padding:15px;background:var(--dark);border-radius:8px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">‡∏Ñ‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏¢</div>
                <div style="font-size:1.3rem;font-weight:bold;color:var(--success);" id="salesCommission">‡∏ø0</div>
              </div>
              <div style="flex:1;min-width:200px;padding:15px;background:var(--dark);border-radius:8px;">
                <div style="color:var(--text-muted);font-size:0.9rem;">‡∏Ñ‡∏≠‡∏°‡∏à‡∏≤‡∏Å‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ (50%)</div>
                <div style="font-size:1.3rem;font-weight:bold;color:var(--warning);" id="renewalCommission">‡∏ø0</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment History -->
        <div class="card mb-20">
          <div class="card-header">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
          </div>
          <div class="card-body">
            <div id="paymentHistoryList">
              <div class="empty-state"><div class="icon">üí∏</div><h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4></div>
            </div>
          </div>
        </div>

        <!-- Commission Log Table -->
        <div class="card">
          <div class="card-header">
            <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</h3>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  </tr>
                </thead>
                <tbody id="commissionTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- All Admins Commission Page (Owner only) -->
      <div class="page hidden" id="page-all-commission">
        <div class="page-header">
          <h2>üíµ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
          <p>‡∏î‡∏π‡πÅ‡∏•‡∏∞‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡πÉ‡∏´‡πâ Admin/Super Admin ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</p>
        </div>

        <div class="card mb-20">
          <div class="card-header">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏°</h3>
            <select class="form-control" style="width:auto;" id="allCommissionMonth" onchange="loadAllCommission()">
              <!-- Dynamic months -->
            </select>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card success">
                <div class="stat-value" id="allTotalEarned">‡∏ø0</div>
                <div class="stat-label">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</div>
              </div>
              <div class="stat-card primary">
                <div class="stat-value" id="allTotalPaid">‡∏ø0</div>
                <div class="stat-label">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
              <div class="stat-card danger">
                <div class="stat-value" id="allTotalUnpaid">‡∏ø0</div>
                <div class="stat-label">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Admin</h3>
          </div>
          <div class="card-body">
            <div id="allAdminsCommissionList">
              <div class="loading"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- Commission Log Details -->
        <div class="card mt-20">
          <div class="card-header">
            <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î CommissionLog</h3>
            <button class="btn btn-sm btn-secondary" onclick="loadCommissionLog()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          </div>
          <div class="card-body">
            <div class="table-container" style="max-height:400px;overflow-y:auto;">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>Admin</th>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                  </tr>
                </thead>
                <tbody id="commissionLogTable">
                  <tr><td colspan="6" class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Reseller: Balance & Payment Page -->
      <div class="page hidden" id="page-my-balance">
        <div class="page-header">
          <h2>üí≥ ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</p>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:24px; margin-bottom:24px;">
          <!-- Left: Stats & History -->
          <div>
            <div class="stats-grid mb-20">
              <div class="stat-card danger">
                <div class="stat-value" id="balancePending">‡∏ø0</div>
                <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
              </div>
              <div class="stat-card success">
                <div class="stat-value" id="balancePaid">‡∏ø0</div>
                <div class="stat-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h3>
              </div>
              <div class="card-body" style="max-height:400px;overflow-y:auto;">
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                        <th>‡πÅ‡∏û‡πá‡∏Å</th>
                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      </tr>
                    </thead>
                    <tbody id="balanceTable">
                      <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Payment Form -->
          <div>
            <div class="card" id="submitPaymentCard">
              <div class="card-header">
                <h3>üì§ ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label>üí∞ ‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</label>
                  <div style="font-size:2rem;font-weight:800;color:var(--danger);margin:10px 0;" id="submitPaymentAmount">‡∏ø0</div>
                </div>

                <div class="form-group">
                  <label>üè¶ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
                  <div style="background:var(--bg-input);padding:16px;border-radius:12px;">
                    <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> <span id="bankNameDisplay">-</span></p>
                    <p style="display:flex;align-items:center;gap:10px;">
                      <strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong>
                      <code id="bankAccountDisplay" style="font-size:1.1rem;">-</code>
                      <button class="btn btn-sm" onclick="copyBankAccount()" title="‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ">üìã</button>
                    </p>
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> <span id="bankAccountNameDisplay">-</span></p>
                  </div>
                </div>

                <div class="form-group">
                  <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</label>
                  <input type="file" class="form-control" id="slipImageInput" accept="image/*" onchange="previewSlip(this)">
                  <div id="slipPreview" style="margin-top:10px;display:none;">
                    <img id="slipPreviewImg" style="max-width:100%;border-radius:8px;">
                  </div>
                </div>

                <button class="btn btn-success btn-block" onclick="submitResellerPayment()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Admins Page (Owner) -->
      <div class="page hidden" id="page-admins">
        <div class="page-header flex-between">
          <div>
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Admin ‡πÅ‡∏•‡∏∞ Reseller</p>
          </div>
          <button class="btn btn-primary" onclick="showAddAdminModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Permissions</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="adminsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Packages Page (Owner) -->
      <div class="page hidden" id="page-packages">
        <div class="page-header flex-between">
          <div>
            <h2>üì¶ ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h2>
            <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</p>
          </div>
          <button class="btn btn-primary" onclick="addPackageRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ Reseller</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ Customer</th>
                    <th>Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="packagesTable">
                  <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="mt-20">
              <button class="btn btn-success" onclick="savePackages()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Commissions Page (Owner) -->
      <div class="page hidden" id="page-commissions">
        <div class="page-header">
          <h2>üíµ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
          <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Admin</p>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Admin</th>
                    <th>Role</th>
                    <th id="commissionPackageHeaders"><!-- Dynamic --></th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="commissionsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- All Transactions Page (Owner) -->
      <div class="page hidden" id="page-all-transactions">
        <div class="page-header">
          <h2>üìë ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h2>
          <p>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Filter</h3>
            <select class="form-control" style="width:auto;" id="filterReseller" onchange="loadAllTransactions()">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <!-- Dynamic -->
            </select>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Reseller</th>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allTransactionsTable">
                  <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page (Owner) -->
      <div class="page hidden" id="page-settings">
        <div class="page-header">
          <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <p>Telegram Notification ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>üì± Telegram Notification</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Bot Token</label>
              <input type="text" class="form-control" id="telegramBotToken" placeholder="123456789:ABCdefGHI...">
              <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á Bot ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà @BotFather</small>
            </div>
            <div class="form-group">
              <label>Chat ID</label>
              <input type="text" class="form-control" id="telegramChatId" placeholder="-1001234567890">
              <small class="text-muted">‡∏´‡∏≤ Chat ID ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å @userinfobot</small>
            </div>
            <div class="form-group">
              <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô)</label>
              <input type="number" class="form-control" id="notifyDaysBefore" value="3" min="1" max="7">
            </div>
            <div class="flex gap-10">
              <button class="btn btn-secondary" onclick="testTelegram()">üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
              <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Owner: Bank Settings Page -->
      <div class="page hidden" id="page-bank-settings">
        <div class="page-header">
          <h2>üè¶ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h2>
          <p>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Reseller ‡πÅ‡∏•‡∏∞ Customer</p>
        </div>

        <div class="card" style="max-width:500px;">
          <div class="card-body">
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
              <input type="text" class="form-control" id="editBankName" placeholder="‡∏ò.‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢, ‡∏ò.‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå, etc.">
            </div>
            <div class="form-group">
              <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
              <input type="text" class="form-control" id="editBankAccountNumber" placeholder="xxx-x-xxxxx-x">
            </div>
            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
              <input type="text" class="form-control" id="editBankAccountName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <button class="btn btn-success btn-block" onclick="saveBankSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- FAB Support Button -->
  <a href="https://m.me/719837687869400" target="_blank" class="fab-support" title="‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ã‡∏±‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ó">
    <svg viewBox="0 0 24 24" fill="currentColor" width="28" height="28">
      <path d="M12 2C6.477 2 2 6.145 2 11.243c0 2.936 1.444 5.544 3.7 7.248V22l3.405-1.869c.91.252 1.87.388 2.895.388 5.523 0 10-4.145 10-9.276C22 6.145 17.523 2 12 2zm1.002 12.478l-2.547-2.715-4.97 2.715 5.466-5.8 2.61 2.715 4.907-2.715-5.466 5.8z"/>
    </svg>
  </a>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modals -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <div class="modal" id="modalContent">
      <!-- Dynamic modal content -->
    </div>
  </div>

  <script>
    // =============== GLOBAL STATE ===============
    const API_URL = '';
    const token = localStorage.getItem('ultra_token');
    const user = JSON.parse(localStorage.getItem('ultra_user') || '{}');

    let packages = [];
    let selectedSubEmails = [];
    let selectedPackage = null;
    let allAdmins = [];

    // =============== AUTH CHECK ===============
    if (!token) {
      window.location.href = '/';
    }

    // Setup UI based on role
    document.getElementById('displayUsername').textContent = user.username || '-';
    document.getElementById('displayRole').textContent = getRoleDisplay(user.role);

    function getRoleDisplay(role) {
      const roles = {
        'owner': 'Owner',
        'super_admin': 'Super Admin',
        'admin': 'Admin',
        'reseller': 'Reseller',
        'customer': 'Customer'
      };
      return roles[role] || role;
    }

    // Show/hide navigation based on role
    const isAdmin = user.role === 'owner' || user.role === 'super_admin' || user.role === 'admin';
    const isOwnerOrSuper = user.role === 'owner' || user.role === 'super_admin';

    if (isOwnerOrSuper) {
      document.getElementById('navStockSection').style.display = 'block';
    }
    if (isAdmin) {
      document.getElementById('navCommissionSection').style.display = 'block';
    }
    if (user.role === 'reseller') {
      document.getElementById('navResellerSection').style.display = 'block';
    }
    if (isOwnerOrSuper) {
      document.getElementById('navAdminSection').style.display = 'block';
    }

    // Hide search for Customer/Reseller (they can search in their own history)
    if (user.role === 'customer' || user.role === 'reseller') {
      document.getElementById('navSearchLink').style.display = 'none';
    }

    // Show correct dashboard stats based on role
    if (isAdmin) {
      document.getElementById('statsGridAdmin').style.display = 'grid';
      document.getElementById('dashboardSubtitle').textContent = '‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö ULTRA Stock';
    } else {
      document.getElementById('statsGridUser').style.display = 'block';
      document.getElementById('dashboardSubtitle').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì';
      if (user.role === 'reseller') {
        document.getElementById('resellerBalanceCard').style.display = 'block';
      }
    }

    // Show correct buy buttons based on role
    if (isAdmin) {
      document.getElementById('buyBtnAdmin').style.display = 'flex';
      // Check permission for buy without commission (only owner/super can buy stock)
      const canBuyStock = isOwnerOrSuper ||
        (user.permissions && user.permissions.canBuyWithoutCommission);
      if (!canBuyStock) {
        document.getElementById('btnBuyStock').style.display = 'none';
      }
    } else if (user.role === 'reseller') {
      document.getElementById('buyBtnReseller').style.display = 'block';
    } else if (user.role === 'customer') {
      document.getElementById('buyBtnCustomer').style.display = 'block';
    }

    // =============== NAVIGATION ===============
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = link.dataset.page;
        navigateTo(page);
      });
    });

    function navigateTo(page) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');

      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById('page-' + page).classList.remove('hidden');

      // Load page data
      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'buy': loadBuyPage(); break;
        case 'search': break;
        case 'history': loadHistory(); break;
        case 'main-emails': loadMainEmails(); break;
        case 'stock': loadStockTable(); break;
        case 'expiring': loadExpiring(); break;
        case 'my-commission': loadMyCommission(); break;
        case 'my-balance': loadMyBalance(); break;
        case 'admins': loadAdmins(); break;
        case 'packages': loadPackages(); break;
        case 'commissions': loadCommissions(); break;
        case 'all-commission': loadAllCommission(); break;
        case 'all-transactions': loadAllTransactions(); break;
        case 'bank-settings': loadBankSettings(); break;
        case 'settings': loadSettings(); break;
      }

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // =============== LOADING ===============
    let loadingCount = 0;

    function showLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...') {
      loadingCount++;
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.querySelector('.loading-text').textContent = text;
    }

    function hideLoading() {
      loadingCount--;
      if (loadingCount <= 0) {
        loadingCount = 0;
        document.getElementById('loadingOverlay').style.display = 'none';
      }
    }

    // =============== API HELPERS ===============
    async function apiGet(endpoint, showLoader = true) {
      if (showLoader) showLoading();
      try {
        const response = await fetch(API_URL + endpoint, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        return response.json();
      } finally {
        if (showLoader) hideLoading();
      }
    }

    async function apiPost(endpoint, data, loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
      showLoading(loadingText);
      try {
        const response = await fetch(API_URL + endpoint, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        return response.json();
      } finally {
        hideLoading();
      }
    }

    async function apiPut(endpoint, data, loadingText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...') {
      showLoading(loadingText);
      try {
        const response = await fetch(API_URL + endpoint, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        return response.json();
      } finally {
        hideLoading();
      }
    }

    async function apiDelete(endpoint) {
      showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
      try {
        const response = await fetch(API_URL + endpoint, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        return response.json();
      } finally {
        hideLoading();
      }
    }

    // =============== TOAST ===============
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // =============== MODAL ===============
    function showModal(title, content) {
      document.getElementById('modalContent').innerHTML = `
        <div class="modal-header">
          <h3>${title}</h3>
          <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-body">${content}</div>
      `;
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }

    // =============== DASHBOARD ===============
    async function loadDashboard() {
      const isAdminRole = user.role === 'owner' || user.role === 'super_admin' || user.role === 'admin';

      if (isAdminRole) {
        // Admin/Owner - load full system stats
        const data = await apiGet('/api/dashboard');
        if (data.success) {
          document.getElementById('statTodaySales').textContent = data.stats.todaySales || 0;
          document.getElementById('statTotalSales').textContent = data.stats.totalSales || 0;
          document.getElementById('statMonthSales').textContent = data.stats.monthSales || 0;
          document.getElementById('statStock').textContent = data.stats.stockCount || 0;
          document.getElementById('statExpiring').textContent = data.stats.expiringCount || 0;

          // Show my stats for admin (not owner)
          if (user.role !== 'owner') {
            document.getElementById('myStatsCard').style.display = 'block';
            document.getElementById('statMySales').textContent = data.stats.mySales || 0;
            document.getElementById('statMyMonthSales').textContent = data.stats.myMonthSales || 0;
            document.getElementById('statMyCommission').textContent = '‡∏ø' + (data.stats.myCommission || 0).toLocaleString();
          }

          // Show main email capacity for owner/super_admin
          if ((user.role === 'owner' || user.role === 'super_admin') && data.stats.mainEmailStats) {
            const mes = data.stats.mainEmailStats;
            document.getElementById('mainEmailCapacityCard').style.display = 'block';
            document.getElementById('statTotalMain').textContent = mes.totalMainEmails;
            document.getElementById('statFullMain').textContent = mes.fullMainEmails;
            document.getElementById('statTotalStock').textContent = mes.totalStock || 0;
            document.getElementById('statAvailableSlots').textContent = mes.totalAvailableSlots;

            // Store for telegram report
            window.mainEmailStats = mes;
            window.dashboardStats = data.stats;

            // Render main email list
            const listDiv = document.getElementById('mainEmailList');
            if (mes.mainEmails.length === 0) {
              listDiv.innerHTML = '<div class="empty-state"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</p></div>';
            } else {
              listDiv.innerHTML = `
                <div class="table-container">
                  <table>
                    <thead>
                      <tr>
                        <th>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</th>
                        <th>‡πÉ‡∏ä‡πâ/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
                        <th>‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                        <th>‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</th>
                        <th>‡∏ß‡πà‡∏≤‡∏á</th>
                        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${mes.mainEmails.map(m => `
                        <tr>
                          <td><code style="font-size:0.85rem;">${m.email}</code></td>
                          <td><strong>${m.used}</strong>/${m.capacity}</td>
                          <td><span class="badge badge-warning">${m.stock}</span></td>
                          <td><span class="badge badge-success">${m.sold}</span></td>
                          <td><strong>${m.available}</strong></td>
                          <td>
                            <span class="badge ${m.isFull ? 'badge-danger' : m.available <= 10 ? 'badge-warning' : 'badge-success'}">
                              ${m.isFull ? '‡πÄ‡∏ï‡πá‡∏°' : m.available <= 10 ? '‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°' : '‡∏õ‡∏Å‡∏ï‡∏¥'}
                            </span>
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              `;
            }
          }
        }
      } else {
        // Customer/Reseller - load only their own purchase data
        await loadUserDashboard();
      }
    }

    // Load dashboard for Customer/Reseller (their own data only)
    async function loadUserDashboard() {
      // Load their orders to get stats
      const data = await apiGet('/api/orders?filter=mine');
      if (data.success) {
        const orders = data.orders || [];
        const now = new Date();

        let totalPurchases = orders.length;
        let activeCount = 0;
        let expiringCount = 0;

        orders.forEach(o => {
          const expiresAt = new Date(o.expiresAt);
          const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));

          if (o.status === 'active' && daysLeft > 0) {
            activeCount++;
            if (daysLeft <= 7) {
              expiringCount++;
            }
          }
        });

        document.getElementById('statUserTotalPurchases').textContent = totalPurchases;
        document.getElementById('statUserActive').textContent = activeCount;
        document.getElementById('statUserExpiring').textContent = expiringCount;
      }

      // Load reseller balance if applicable
      if (user.role === 'reseller') {
        const balanceData = await apiGet('/api/reseller/balance');
        if (balanceData.success) {
          document.getElementById('statResellerBalance').textContent = '‡∏ø' + (balanceData.pending || 0).toLocaleString();
        }
      }
    }

    // =============== BUY PAGE ===============
    let availableStock = [];

    async function loadBuyPage() {
      // Load packages
      const pkgData = await apiGet('/api/packages');
      if (pkgData.success) {
        packages = pkgData.packages.filter(p => p.active);
        renderPackageOptions();
        // Select first package by default
        if (packages.length > 0 && !selectedPackage) {
          selectedPackage = packages[0].days;
          renderPackageOptions();
        }
      }

      // Load stock count
      const stockData = await apiGet('/api/sub-emails?status=stock');
      if (stockData.success) {
        availableStock = stockData.emails;
        document.getElementById('stockAvailable').textContent = stockData.emails.length;
        // Set max quantity
        document.getElementById('buyQuantity').max = stockData.emails.length;
      }
    }

    function getPackagePrice(pkg) {
      // Return the correct price based on user role
      if (user.role === 'customer') {
        return pkg.customerPrice || pkg.price || 0;
      } else {
        return pkg.resellerPrice || pkg.price || 0;
      }
    }

    function renderPackageOptions() {
      const container = document.getElementById('packageOptions');
      container.innerHTML = packages.map(pkg => {
        const price = getPackagePrice(pkg);
        return `
          <div class="package-option ${selectedPackage === pkg.days ? 'selected' : ''}"
               onclick="selectPackage(${pkg.days})">
            <div class="package-days">${pkg.days}</div>
            <div class="package-name">${pkg.name}</div>
            <div class="package-price" style="font-size:0.85rem;color:var(--success);">‡∏ø${price.toLocaleString()}</div>
          </div>
        `;
      }).join('');
      updatePriceSummary();
    }

    function selectPackage(days) {
      selectedPackage = days;
      renderPackageOptions();
    }

    function updatePriceSummary() {
      const quantity = parseInt(document.getElementById('buyQuantity').value) || 1;
      const pkg = packages.find(p => p.days === selectedPackage);
      if (pkg) {
        const price = getPackagePrice(pkg);
        const total = price * quantity;
        document.getElementById('totalPrice').textContent = '‡∏ø' + total.toLocaleString();
      }
    }

    // Update price when quantity changes
    document.getElementById('buyQuantity').addEventListener('input', updatePriceSummary);

    async function buyDirect() {
      await doBuy('direct');
    }

    async function buyStock() {
      await doBuy('stock');
    }

    async function doBuy(saleType) {
      const quantity = parseInt(document.getElementById('buyQuantity').value) || 1;

      if (quantity < 1) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'warning');
        return;
      }
      if (quantity > availableStock.length) {
        showToast(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏°‡∏µ ${availableStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, 'warning');
        return;
      }
      if (!selectedPackage) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à', 'warning');
        return;
      }

      // Get first N stock items
      const subEmailIds = availableStock.slice(0, quantity).map(e => e.id);
      const customerName = document.getElementById('customerName').value;

      const data = await apiPost('/api/orders', {
        subEmailIds,
        packageDays: selectedPackage,
        customerName,
        saleType
      }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠...');

      if (data.success) {
        // Show result modal with nice format
        const pkg = packages.find(p => p.days === selectedPackage);
        const expiryDate = formatDate(data.orders[0]?.expiresAt);

        const resultHtml = `
          <div style="text-align:center;margin-bottom:25px;">
            <div style="font-size:4rem;">‚úÖ</div>
            <h3 style="margin:10px 0;">‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.orders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
            <p style="color:var(--text-muted);">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ${pkg?.name || selectedPackage + ' ‡∏ß‡∏±‡∏ô'} | ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ${expiryDate}</p>
          </div>

          <div style="background:var(--dark); border-radius:12px; padding:20px; margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
              <span style="font-weight:600;">üìß ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
              <button class="btn btn-sm btn-primary" onclick="copyOrdersFormatted()">üìã Copy ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
            <div id="ordersForCopy" style="font-family:monospace; font-size:0.9rem; line-height:1.8;">
              ${data.orders.map((o, i) => `
                <div style="padding:10px; background:var(--card); border-radius:8px; margin-bottom:8px;">
                  <div><strong>${i+1}.</strong></div>
                  <div>Email: <code style="color:var(--primary)">${o.email}</code></div>
                  <div>Password: <code>${o.password}</code></div>
                </div>
              `).join('')}
            </div>
          </div>

          <div style="text-align:center;">
            <button class="btn btn-secondary" onclick="hideModal()">‡∏õ‡∏¥‡∏î</button>
          </div>
        `;

        // Store orders for copy function
        window.lastOrders = data.orders;

        showModal('üéâ ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', resultHtml);

        // Reset
        document.getElementById('buyQuantity').value = '1';
        document.getElementById('customerName').value = '';
        loadBuyPage();
      } else {
        showToast(data.error, 'error');
      }
    }

    function copyOrdersFormatted() {
      if (!window.lastOrders) return;

      const text = window.lastOrders.map((o, i) =>
        `${i+1}.\nEmail: ${o.email}\nPassword: ${o.password}`
      ).join('\n\n');

      navigator.clipboard.writeText(text);
      showToast('Copied! ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤', 'success');
    }

    // =============== CUSTOMER BUY FLOW ===============
    async function customerBuy() {
      const quantity = parseInt(document.getElementById('buyQuantity').value) || 1;

      if (quantity < 1) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'warning');
        return;
      }
      if (quantity > availableStock.length) {
        showToast(`‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏°‡∏µ ${availableStock.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, 'warning');
        return;
      }
      if (!selectedPackage) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à', 'warning');
        return;
      }

      // Get first N stock items
      const subEmailIds = availableStock.slice(0, quantity).map(e => e.id);
      const customerName = document.getElementById('customerName').value;
      const pkg = packages.find(p => p.days === selectedPackage);
      const price = getPackagePrice(pkg);
      const totalAmount = price * quantity;

      // Create pending order
      const data = await apiPost('/api/customer/pending-order', {
        subEmailIds,
        packageDays: selectedPackage,
        customerName,
        totalAmount
      }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...');

      if (data.success) {
        // Show payment modal with bank info
        showCustomerPaymentModal(data.pendingOrder.id, totalAmount, quantity, pkg);
      } else {
        showToast(data.error, 'error');
      }
    }

    async function showCustomerPaymentModal(orderId, amount, quantity, pkg) {
      // Load bank account info
      const bankData = await apiGet('/api/bank-account', false);
      const bank = bankData.bankAccount || {};

      showModal('üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô', `
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:2.5rem;font-weight:bold;color:var(--warning);">‡∏ø${amount.toLocaleString()}</div>
          <p class="text-muted">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
          <p style="font-size:0.9rem;color:var(--text-muted);">${quantity} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ x ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ${pkg.name}</p>
        </div>

        <div style="background:var(--dark);padding:20px;border-radius:12px;margin-bottom:20px;">
          <h4 style="margin-bottom:15px;color:var(--primary);">üìå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</h4>
          <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${bank.bankName || '-'}</p>
          <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> <code style="font-size:1.1rem;color:var(--success);">${bank.accountNumber || '-'}</code>
            <button class="btn btn-sm" style="margin-left:10px;padding:5px 10px;" onclick="copyToClipboard('${bank.accountNumber || ''}')">üìã</button>
          </p>
          <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ${bank.accountName || '-'}</p>
        </div>

        <div style="background:rgba(255,193,7,0.1);padding:15px;border-radius:8px;margin-bottom:20px;border:1px solid var(--warning);">
          <p style="color:var(--warning);font-size:0.9rem;margin:0;">
            ‚è∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 30 ‡∏ô‡∏≤‡∏ó‡∏µ ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
          </p>
        </div>

        <div class="form-group">
          <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</label>
          <input type="file" class="form-control" id="customerBuySlipInput" accept="image/*" onchange="previewCustomerBuySlip(this)">
          <div id="customerBuySlipPreview" style="margin-top:10px;display:none;">
            <img id="customerBuySlipPreviewImg" style="max-width:100%;border-radius:8px;">
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="submitCustomerBuyPayment('${orderId}')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        <button class="btn btn-secondary btn-block" style="margin-top:10px;" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      `);
    }

    function previewCustomerBuySlip(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('customerBuySlipPreviewImg').src = e.target.result;
          document.getElementById('customerBuySlipPreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function submitCustomerBuyPayment(orderId) {
      const fileInput = document.getElementById('customerBuySlipInput');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ', 'warning');
        return;
      }

      // Convert image to base64
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];

        const data = await apiPost('/api/customer/pay-order', {
          orderId,
          slipImage: base64
        }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ...');

        if (data.success) {
          hideModal();
          showToast(data.message || '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');

          // Show purchased emails
          if (data.orders && data.orders.length > 0) {
            showPurchaseResult(data.orders);
          }

          // Reload buy page
          loadBuyPage();
        } else {
          showToast(data.error, 'error');
        }
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success'));
    }

    function copyBankAccount() {
      const accountNumber = document.getElementById('bankAccountDisplay').textContent;
      if (accountNumber && accountNumber !== '-') {
        navigator.clipboard.writeText(accountNumber).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß!', 'success'));
      }
    }

    // =============== SEARCH ===============
    async function searchSubEmail() {
      const email = document.getElementById('searchEmail').value;
      if (!email) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', 'warning');
        return;
      }

      const data = await apiGet('/api/sub-emails/search?email=' + encodeURIComponent(email));
      const resultDiv = document.getElementById('searchResult');

      if (data.success) {
        const r = data.result;
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="card mt-20">
            <div class="card-header">
              <h3>üìß ${r.email}</h3>
              <span class="badge ${r.status === 'sold' ? 'badge-success' : 'badge-warning'}">${r.status}</span>
            </div>
            <div class="card-body">
              <p><strong>Password:</strong> ${r.password}</p>
              <hr style="margin:15px 0;border-color:var(--border);">
              <p><strong>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•:</strong> ${r.mainEmail ? r.mainEmail.email : '-'}</p>
              ${r.mainEmail && r.mainEmail.password ? `<p><strong>‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•:</strong> <code>${r.mainEmail.password}</code></p>` : ''}
              ${r.order ? `
                <hr style="margin:15px 0;border-color:var(--border);">
                <p><strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${r.order.customerName || '-'}</p>
                <p><strong>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à:</strong> ${r.order.packageDays} ‡∏ß‡∏±‡∏ô</p>
                <p><strong>‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢:</strong> ${r.order.soldBy}</p>
                <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${formatDate(r.order.expiresAt)}</p>
                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="badge ${r.order.status === 'expired' ? 'badge-danger' : 'badge-success'}">${r.order.status}</span></p>
              ` : ''}
            </div>
          </div>
        `;
      } else {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<div class="empty-state mt-20"><div class="icon">üîç</div><h3>${data.error}</h3></div>`;
      }
    }

    // =============== HISTORY ===============
    async function loadHistory() {
      const filter = document.getElementById('historyFilter').value;
      let url = '/api/orders?filter=mine';
      if (filter !== 'all') url += '&saleType=' + filter;

      const data = await apiGet(url);
      const container = document.getElementById('historyList');

      if (data.success && data.orders.length > 0) {
        // Group orders by orderId (same timestamp + soldBy = same order)
        const grouped = {};
        data.orders.forEach(o => {
          const key = o.orderId || `${o.soldAt}_${o.soldBy}`;
          if (!grouped[key]) {
            grouped[key] = {
              orderId: key,
              soldAt: o.soldAt,
              soldBy: o.soldBy,
              customerName: o.customerName,
              packageDays: o.packageDays,
              saleType: o.saleType,
              items: []
            };
          }
          grouped[key].items.push({
            email: o.subEmail,
            password: o.password || '***',
            expiresAt: o.expiresAt,
            status: o.status
          });
        });

        const orders = Object.values(grouped).sort((a, b) =>
          new Date(b.soldAt) - new Date(a.soldAt)
        );

        container.innerHTML = orders.map((order, idx) => `
          <div class="order-card" style="border:1px solid var(--border);border-radius:8px;margin-bottom:10px;overflow:hidden;">
            <div class="order-header" onclick="toggleOrderDetail(${idx})" style="padding:15px;background:var(--card-bg);cursor:pointer;display:flex;justify-content:space-between;align-items:center;">
              <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                <span style="font-weight:bold;">#${idx + 1}</span>
                <span>${formatDate(order.soldAt)}</span>
                <span class="badge ${order.saleType === 'direct' ? 'badge-success' : 'badge-secondary'}">${order.saleType === 'direct' ? '‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á' : '‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å'}</span>
                <span><strong>${order.items.length}</strong> ‡πÄ‡∏°‡∏•</span>
                <span>${order.packageDays} ‡∏ß‡∏±‡∏ô</span>
                ${order.customerName ? `<span>üë§ ${order.customerName}</span>` : ''}
              </div>
              <span class="order-toggle" id="toggle-${idx}" style="font-size:1.2rem;">‚ñº</span>
            </div>
            <div class="order-detail" id="order-detail-${idx}" style="display:none;padding:15px;background:var(--bg-color);border-top:1px solid var(--border);">
              <div style="display:flex;justify-content:flex-end;margin-bottom:10px;">
                <button class="btn btn-sm btn-primary" onclick="copyOrderEmails(${idx})">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              </div>
              <div class="order-emails" id="order-emails-${idx}">
                ${order.items.map((item, i) => {
                  const expiryDate = new Date(item.expiresAt);
                  const now = new Date();
                  const daysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
                  const isExpiringSoon = daysLeft > 0 && daysLeft <= 3;
                  const isExpired = item.status === 'expired' || daysLeft <= 0;

                  return `
                  <div style="padding:10px;margin-bottom:8px;background:var(--card-bg);border-radius:6px;border-left:3px solid ${isExpired ? 'var(--danger)' : isExpiringSoon ? 'var(--warning)' : 'var(--success)'};">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
                      <div>
                        <div><strong>${i + 1}.</strong> <code>${item.email}</code></div>
                        <div style="margin-top:5px;color:var(--text-muted);font-size:0.9rem;">Password: <code>${item.password}</code></div>
                        <div style="margin-top:5px;font-size:0.85rem;">
                          ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: <span style="color:${isExpired ? 'var(--danger)' : isExpiringSoon ? 'var(--warning)' : 'var(--text-muted)'};">${formatDate(item.expiresAt)}</span>
                          ${isExpiringSoon ? `<span class="badge badge-warning" style="margin-left:5px;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</span>` : ''}
                          ${isExpired ? `<span class="badge badge-danger" style="margin-left:5px;">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÅ‡∏•‡πâ‡∏ß</span>` : ''}
                        </div>
                      </div>
                      ${isExpiringSoon || isExpired ? `
                        <button class="btn btn-sm btn-warning" onclick="showRenewModal('${item.email}', ${order.packageDays})">üîÑ ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
                      ` : ''}
                    </div>
                  </div>
                `}).join('')}
              </div>
            </div>
          </div>
        `).join('');

        // Store orders for copy function
        window.historyOrders = orders;
      } else {
        container.innerHTML = '<div class="empty-state"><div class="icon">üìã</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h3></div>';
      }
    }

    function toggleOrderDetail(idx) {
      const detail = document.getElementById('order-detail-' + idx);
      const toggle = document.getElementById('toggle-' + idx);
      if (detail.style.display === 'none') {
        detail.style.display = 'block';
        toggle.textContent = '‚ñ≤';
      } else {
        detail.style.display = 'none';
        toggle.textContent = '‚ñº';
      }
    }

    function copyOrderEmails(idx) {
      const order = window.historyOrders[idx];
      const text = order.items.map((item, i) =>
        `${i + 1}.\nEmail: ${item.email}\nPassword: ${item.password}`
      ).join('\n\n');

      navigator.clipboard.writeText(text).then(() => {
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success');
      });
    }

    // =============== MAIN EMAILS ===============
    async function loadMainEmails() {
      const data = await apiGet('/api/main-emails');
      const tbody = document.getElementById('mainEmailsTable');

      if (data.success && data.emails.length > 0) {
        tbody.innerHTML = data.emails.map(e => `
          <tr>
            <td><code>${e.email}</code></td>
            <td>${e.password}</td>
            <td>${e.usedSlots}/${e.capacity}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editMainEmail('${e.id}', '${e.email}', '${e.password}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-sm btn-danger" onclick="deleteMainEmail('${e.id}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</td></tr>';
      }
    }

    function showAddMainEmailModal() {
      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="newMainEmail" placeholder="main@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="newMainPassword" placeholder="password">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addMainEmail()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      `);
    }

    async function addMainEmail() {
      const email = document.getElementById('newMainEmail').value;
      const password = document.getElementById('newMainPassword').value;

      if (!email || !password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }

      const data = await apiPost('/api/main-emails', { email, password });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    function editMainEmail(id, email, password) {
      showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="editMainEmail" value="${email}">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="editMainPassword" value="${password}">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="updateMainEmail('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      `);
    }

    async function updateMainEmail(id) {
      const email = document.getElementById('editMainEmail').value;
      const password = document.getElementById('editMainPassword').value;

      const data = await apiPut('/api/main-emails/' + id, { email, password });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteMainEmail(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/main-emails/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== STOCK TABLE ===============
    async function loadStockTable() {
      const data = await apiGet('/api/sub-emails?status=stock');
      const tbody = document.getElementById('stockTable');

      if (data.success && data.emails.length > 0) {
        tbody.innerHTML = data.emails.map(e => `
          <tr>
            <td><code>${e.email}</code></td>
            <td>${e.password}</td>
            <td>${e.mainEmail}</td>
            <td><span class="badge badge-warning">${e.status}</span></td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteSubEmail('${e.id}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>';
      }
    }

    async function showAddStockModal() {
      // Load main emails
      const mainData = await apiGet('/api/main-emails');

      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</label>
          <select class="form-control" id="stockMainEmailId">
            ${mainData.emails.map(e => `<option value="${e.id}">${e.email} (${e.usedSlots}/${e.capacity})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏• (email:password ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)</label>
          <textarea class="form-control" id="stockEmails" rows="6" placeholder="sub1@example.com:password1
sub2@example.com:password2"></textarea>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addStock()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
        </div>
      `);
    }

    async function addStock() {
      const mainEmailId = document.getElementById('stockMainEmailId').value;
      const emailsText = document.getElementById('stockEmails').value;

      const emails = emailsText.split('\n')
        .map(line => line.trim())
        .filter(line => line.includes(':'))
        .map(line => {
          const [email, password] = line.split(':');
          return { email: email.trim(), password: password.trim() };
        });

      if (emails.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', 'warning');
        return;
      }

      const data = await apiPost('/api/sub-emails', { mainEmailId, emails });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadStockTable();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteSubEmail(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/sub-emails/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadStockTable();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== EXPIRING ===============
    async function loadExpiring() {
      const data = await apiGet('/api/expiring?days=7');
      const container = document.getElementById('expiringContent');

      if (data.success) {
        const { today, soon, upcoming } = data.expiring;

        if (today.length === 0 && soon.length === 0 && upcoming.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h3></div>';
          return;
        }

        container.innerHTML = `
          ${renderExpirySection('today', '‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', today)}
          ${renderExpirySection('soon', '‡∏´‡∏°‡∏î‡πÉ‡∏ô 1-3 ‡∏ß‡∏±‡∏ô', soon)}
          ${renderExpirySection('upcoming', '‡∏´‡∏°‡∏î‡πÉ‡∏ô 4-7 ‡∏ß‡∏±‡∏ô', upcoming)}
        `;
      }
    }

    function renderExpirySection(type, title, items) {
      if (items.length === 0) return '';

      return `
        <div class="expiry-section">
          <div class="expiry-section-header ${type}">
            <span>${type === 'today' ? 'üî¥' : type === 'soon' ? 'üü†' : 'üü°'}</span>
            <h4>${title}</h4>
            <span class="expiry-count">${items.length}</span>
          </div>
          ${items.map(item => `
            <div class="expiry-card">
              <div class="expiry-card-header">
                <span class="expiry-email">${item.subEmail}</span>
                <span class="expiry-${type}">${item.daysUntil <= 0 ? '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!' : item.daysUntil + ' ‡∏ß‡∏±‡∏ô'}</span>
              </div>
              <div class="expiry-card-body">
                <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${item.customerName || '-'}</div>
                <div>‡πÅ‡∏û‡πá‡∏Å: ${item.packageDays} ‡∏ß‡∏±‡∏ô</div>
                <div>‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${item.soldBy}</div>
                <div>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${formatDate(item.expiresAt)}</div>
                ${item.mainEmail ? `<div>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•: ${item.mainEmail.email}</div>` : ''}
                ${item.mainEmail && item.mainEmail.password ? `<div>‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•: <code>${item.mainEmail.password}</code></div>` : ''}
              </div>
              <div class="expiry-card-actions">
                <button class="btn btn-sm btn-warning" onclick="showExtendModal('${item.id}')">‚ûï ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
                <button class="btn btn-sm btn-danger" onclick="markExpired('${item.id}')">üóëÔ∏è ‡∏•‡∏ö (‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß)</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showExtendModal(orderId) {
      showModal('‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏', `
        <div class="form-group">
          <label>‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô)</label>
          <input type="number" class="form-control" id="extendDays" value="30" min="1">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-success" onclick="extendOrder('${orderId}')">‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
        </div>
      `);
    }

    async function extendOrder(orderId) {
      const days = parseInt(document.getElementById('extendDays').value);
      if (!days || days < 1) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô', 'warning');
        return;
      }

      const data = await apiPut('/api/orders/' + orderId + '/extend', { days });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadExpiring();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function markExpired(orderId) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ? (‡πÄ‡∏°‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)')) return;

      const data = await apiPut('/api/orders/' + orderId + '/expire');
      if (data.success) {
        showToast(data.message, 'success');
        loadExpiring();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== RENEWAL SYSTEM ===============
    function showRenewModal(email, currentPackageDays) {
      // Build package options with prices based on role
      const pkgOptions = packages.map(pkg => {
        const price = getPackagePrice(pkg);
        return `<option value="${pkg.days}" ${pkg.days === currentPackageDays ? 'selected' : ''}>${pkg.name} - ‡∏ø${price.toLocaleString()}</option>`;
      }).join('');

      const isCustomer = user.role === 'customer';
      const buttonText = isCustomer ? 'üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' : 'üîÑ ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏';
      const buttonClass = isCustomer ? 'btn-success' : 'btn-warning';

      showModal('üîÑ ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏°‡∏•', `
        <div style="text-align:center;margin-bottom:20px;">
          <code style="font-size:1.1rem;">${email}</code>
        </div>

        <div class="form-group">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</label>
          <select class="form-control" id="renewPackageSelect" onchange="updateRenewPrice()">
            ${pkgOptions}
          </select>
        </div>

        <div id="renewPriceDisplay" style="text-align:center;padding:15px;background:var(--dark);border-radius:8px;margin-bottom:20px;">
          <span class="text-muted">‡∏£‡∏≤‡∏Ñ‡∏≤:</span>
          <span id="renewPriceValue" style="font-size:1.5rem;font-weight:bold;color:var(--success);margin-left:10px;">‡∏ø0</span>
        </div>

        ${isCustomer ? `
          <div style="background:rgba(255,193,7,0.1);padding:10px;border-radius:8px;margin-bottom:15px;border:1px solid var(--warning);">
            <p style="color:var(--warning);font-size:0.85rem;margin:0;">üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</p>
          </div>
        ` : ''}

        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn ${buttonClass}" onclick="processRenewal('${email}')">${buttonText}</button>
        </div>
      `);

      // Update initial price
      updateRenewPrice();
    }

    function updateRenewPrice() {
      const selectedDays = parseInt(document.getElementById('renewPackageSelect').value);
      const pkg = packages.find(p => p.days === selectedDays);
      if (pkg) {
        const price = getPackagePrice(pkg);
        document.getElementById('renewPriceValue').textContent = '‡∏ø' + price.toLocaleString();
      }
    }

    async function processRenewal(email) {
      const packageDays = parseInt(document.getElementById('renewPackageSelect').value);
      const pkg = packages.find(p => p.days === packageDays);
      const price = getPackagePrice(pkg);

      if (user.role === 'customer') {
        // Customer needs to pay first - show payment modal
        hideModal();
        await showRenewalPaymentModal(email, packageDays, price, pkg);
      } else {
        // Admin/Reseller can renew directly (will be added to balance for reseller)
        const data = await apiPost('/api/orders/renew', {
          email,
          packageDays
        }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏...');

        if (data.success) {
          showToast(data.message || '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          hideModal();
          loadHistory();
          loadExpiring();
        } else {
          showToast(data.error, 'error');
        }
      }
    }

    async function showRenewalPaymentModal(email, packageDays, amount, pkg) {
      // Load bank account info
      const bankData = await apiGet('/api/bank-account', false);
      const bank = bankData.bankAccount || {};

      showModal('üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏', `
        <div style="text-align:center;margin-bottom:20px;">
          <code style="font-size:1rem;">${email}</code>
          <div style="font-size:2rem;font-weight:bold;color:var(--warning);margin-top:10px;">‡∏ø${amount.toLocaleString()}</div>
          <p class="text-muted">‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à ${pkg.name}</p>
        </div>

        <div style="background:var(--dark);padding:20px;border-radius:12px;margin-bottom:20px;">
          <h4 style="margin-bottom:15px;color:var(--primary);">üìå ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</h4>
          <p><strong>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£:</strong> ${bank.bankName || '-'}</p>
          <p><strong>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> <code style="font-size:1.1rem;color:var(--success);">${bank.accountNumber || '-'}</code>
            <button class="btn btn-sm" style="margin-left:10px;padding:5px 10px;" onclick="copyToClipboard('${bank.accountNumber || ''}')">üìã</button>
          </p>
          <p><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ${bank.accountName || '-'}</p>
        </div>

        <div class="form-group">
          <label>üì∑ ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</label>
          <input type="file" class="form-control" id="renewSlipInput" accept="image/*" onchange="previewRenewSlip(this)">
          <div id="renewSlipPreview" style="margin-top:10px;display:none;">
            <img id="renewSlipPreviewImg" style="max-width:100%;border-radius:8px;">
          </div>
        </div>

        <button class="btn btn-success btn-block" onclick="submitRenewalPayment('${email}', ${packageDays}, ${amount})">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
        <button class="btn btn-secondary btn-block" style="margin-top:10px;" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      `);
    }

    function previewRenewSlip(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('renewSlipPreviewImg').src = e.target.result;
          document.getElementById('renewSlipPreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function submitRenewalPayment(email, packageDays, amount) {
      const fileInput = document.getElementById('renewSlipInput');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ', 'warning');
        return;
      }

      // Convert image to base64
      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];

        const data = await apiPost('/api/orders/renew-with-payment', {
          email,
          packageDays,
          amount,
          slipImage: base64
        }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ...');

        if (data.success) {
          hideModal();
          showToast(data.message || '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          loadHistory();
        } else {
          showToast(data.error, 'error');
        }
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    // =============== MY COMMISSION ===============
    function loadMyCommission() {
      // Setup month selector
      const select = document.getElementById('commissionMonth');
      if (select.options.length === 0) {
        const now = new Date();
        for (let i = 0; i < 6; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const value = d.toISOString().substring(0, 7);
          const label = d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
          select.innerHTML += `<option value="${value}">${label}</option>`;
        }
      }

      loadCommissionData();
    }

    async function loadCommissionData() {
      const month = document.getElementById('commissionMonth').value;

      // Load enhanced commission stats
      const statsData = await apiGet(`/api/admin-commission/${user.id}?month=${month}`);
      if (statsData.success) {
        const s = statsData.stats;
        document.getElementById('totalEarned').textContent = '‡∏ø' + s.totalEarned.toLocaleString();
        document.getElementById('totalPaid').textContent = '‡∏ø' + s.totalPaid.toLocaleString();
        document.getElementById('totalUnpaid').textContent = '‡∏ø' + s.unpaid.toLocaleString();
        document.getElementById('totalBonus').textContent = '‡∏ø' + s.bonus.toLocaleString();
        document.getElementById('salesCommission').textContent = '‡∏ø' + s.salesCommission.toLocaleString();
        document.getElementById('renewalCommission').textContent = '‡∏ø' + s.renewalCommission.toLocaleString();

        // Render payment history
        const paymentList = document.getElementById('paymentHistoryList');
        if (s.payments && s.payments.length > 0) {
          paymentList.innerHTML = s.payments.map(p => `
            <div style="padding:12px;background:var(--dark);border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;">
              <div>
                <span style="font-size:1.2rem;font-weight:bold;color:var(--success);">‡∏ø${p.amount.toLocaleString()}</span>
                ${p.note ? `<span class="text-muted" style="margin-left:10px;font-size:0.9rem;">${p.note}</span>` : ''}
              </div>
              <span class="text-muted" style="font-size:0.85rem;">${formatDate(p.paidAt)}</span>
            </div>
          `).join('');
        } else {
          paymentList.innerHTML = '<div class="empty-state"><div class="icon">üí∏</div><h4>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4></div>';
        }
      }

      // Load commission log details
      const data = await apiGet('/api/commission-log?month=' + month);
      if (data.success) {
        const tbody = document.getElementById('commissionTable');
        if (data.logs.length > 0) {
          tbody.innerHTML = data.logs.map(log => `
            <tr>
              <td><code>${log.subEmail}</code></td>
              <td>${log.packageDays} ‡∏ß‡∏±‡∏ô</td>
              <td><span class="badge ${log.type === 'renewal' ? 'badge-warning' : 'badge-success'}">${log.type === 'renewal' ? '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏Ç‡∏≤‡∏¢'}</span></td>
              <td class="text-success">‡∏ø${log.amount.toLocaleString()}</td>
              <td>${formatDate(log.createdAt)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</td></tr>';
        }
      }
    }

    // =============== ALL COMMISSION (OWNER) ===============
    function loadAllCommission() {
      // Setup month selector
      const select = document.getElementById('allCommissionMonth');
      if (select.options.length === 0) {
        const now = new Date();
        for (let i = 0; i < 6; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          // Use local date instead of UTC to avoid timezone issues
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const value = `${year}-${month}`;
          const label = d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
          select.innerHTML += `<option value="${value}">${label}</option>`;
        }
      }

      loadAllCommissionData();
    }

    async function loadAllCommissionData() {
      const month = document.getElementById('allCommissionMonth').value;
      const container = document.getElementById('allAdminsCommissionList');

      try {
        const data = await apiGet(`/api/all-admins-commission?month=${month}`);
        console.log('Commission API Response:', data);

        if (data.success) {
          // Update totals
          document.getElementById('allTotalEarned').textContent = '‡∏ø' + (data.totals?.totalEarned || 0).toLocaleString();
          document.getElementById('allTotalPaid').textContent = '‡∏ø' + (data.totals?.totalPaid || 0).toLocaleString();
          document.getElementById('allTotalUnpaid').textContent = '‡∏ø' + (data.totals?.totalUnpaid || 0).toLocaleString();

          // Render admins list
          if (data.admins && data.admins.length > 0) {
            container.innerHTML = data.admins.map(admin => `
              <div style="padding:20px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:15px;">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
                  <div>
                    <h4 style="margin:0;">${admin.adminName}</h4>
                    <div style="display:flex;gap:20px;margin-top:10px;flex-wrap:wrap;">
                      <span>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°: <strong class="text-success">‡∏ø${admin.totalEarned.toLocaleString()}</strong></span>
                      <span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß: <strong class="text-primary">‡∏ø${admin.totalPaid.toLocaleString()}</strong></span>
                      <span>‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢: <strong class="text-danger">‡∏ø${admin.unpaid.toLocaleString()}</strong></span>
                      ${admin.bonus > 0 ? `<span>‡πÇ‡∏ö‡∏ô‡∏±‡∏™: <strong style="color:#9333ea;">‡∏ø${admin.bonus.toLocaleString()}</strong></span>` : ''}
                    </div>
                  </div>
                  <button class="btn btn-success" onclick="showPayCommissionModal('${admin.adminId}', '${admin.adminName}', ${admin.unpaid})">
                    üí∞ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
                  </button>
                </div>
              </div>
            `).join('');
          } else {
            container.innerHTML = '<div class="empty-state"><div class="icon">üë•</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Admin/Super Admin ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</h3><p class="text-muted">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Role ‡∏Ç‡∏≠‡∏á Admin ‡πÉ‡∏ô Sheet</p></div>';
          }
        } else {
          container.innerHTML = `<div class="empty-state"><div class="icon">‚ùå</div><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p class="text-danger">${data.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ'}</p></div>`;
        }
      } catch (err) {
        console.error('Commission Error:', err);
        container.innerHTML = `<div class="empty-state"><div class="icon">‚ùå</div><h3>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3><p class="text-danger">${err.message}</p></div>`;
      }

      // Also load commission log
      loadCommissionLog();
    }

    async function loadCommissionLog() {
      const month = document.getElementById('allCommissionMonth').value;
      const tbody = document.getElementById('commissionLogTable');
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>';

      try {
        const data = await apiGet(`/api/commission-log?month=${month}`);
        console.log('CommissionLog API Response:', data);

        if (data.success && data.logs && data.logs.length > 0) {
          tbody.innerHTML = data.logs.map(log => `
            <tr>
              <td>${formatDate(log.createdAt)}</td>
              <td>${log.adminName}</td>
              <td style="font-size:0.85rem;">${log.subEmail}</td>
              <td>${log.packageDays} ‡∏ß‡∏±‡∏ô</td>
              <td class="text-success">‡∏ø${log.amount.toLocaleString()}</td>
              <td><span class="badge ${log.type === 'renewal' ? 'badge-secondary' : 'badge-success'}">${log.type === 'renewal' ? '‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡∏°‡πà'}</span></td>
            </tr>
          `).join('');
        } else if (data.error) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${data.error}</td></tr>`;
        } else {
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CommissionLog ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (month: ${month})</td></tr>`;
        }
      } catch (err) {
        console.error('CommissionLog Error:', err);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Error: ${err.message}</td></tr>`;
      }
    }

    function showPayCommissionModal(adminId, adminName, unpaidAmount) {
      showModal('üí∞ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°', `
        <div style="text-align:center;margin-bottom:20px;">
          <h3 style="margin:0;">${adminName}</h3>
          <p class="text-muted">‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢: <strong class="text-danger">‡∏ø${unpaidAmount.toLocaleString()}</strong></p>
        </div>

        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢</label>
          <input type="number" class="form-control" id="payCommissionAmount" value="${unpaidAmount}" min="0" style="font-size:1.3rem;text-align:center;">
          <small class="text-muted">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ (‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏ö‡∏ô‡∏±‡∏™)</small>
        </div>

        <div class="form-group">
          <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
          <input type="text" class="form-control" id="payCommissionNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ KPI, ‡∏ó‡∏¥‡∏õ">
        </div>

        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-success" onclick="payCommission('${adminId}')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</button>
        </div>
      `);
    }

    async function payCommission(adminId) {
      const amount = parseFloat(document.getElementById('payCommissionAmount').value);
      const note = document.getElementById('payCommissionNote').value;

      if (!amount || amount <= 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'warning');
        return;
      }

      const data = await apiPost('/api/pay-commission', {
        adminId,
        amount,
        note
      }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadAllCommissionData();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== MY BALANCE (RESELLER) ===============
    async function loadMyBalance() {
      // Load balance stats
      const balanceData = await apiGet('/api/reseller/balance');
      if (balanceData.success) {
        document.getElementById('balancePending').textContent = '‡∏ø' + balanceData.pending.toLocaleString();
        document.getElementById('balancePaid').textContent = '‡∏ø' + balanceData.paid.toLocaleString();
        document.getElementById('submitPaymentAmount').textContent = '‡∏ø' + balanceData.pending.toLocaleString();
      }

      // Load bank account info
      const bankData = await apiGet('/api/bank-account', false);
      if (bankData.success && bankData.bankAccount) {
        document.getElementById('bankNameDisplay').textContent = bankData.bankAccount.bankName || '-';
        document.getElementById('bankAccountDisplay').textContent = bankData.bankAccount.accountNumber || '-';
        document.getElementById('bankAccountNameDisplay').textContent = bankData.bankAccount.accountName || '-';
      }

      // Load transactions
      const txnData = await apiGet('/api/reseller/transactions');
      const tbody = document.getElementById('balanceTable');

      if (txnData.success && txnData.transactions.length > 0) {
        tbody.innerHTML = txnData.transactions.map(t => `
          <tr>
            <td><code style="font-size:0.8rem;">${t.subEmail}</code></td>
            <td>${t.packageDays} ‡∏ß‡∏±‡∏ô</td>
            <td>‡∏ø${t.amount.toLocaleString()}</td>
            <td><span class="badge ${t.status === 'paid' ? 'badge-success' : 'badge-danger'}">${t.status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}</span></td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
      }
    }

    // =============== ADMINS (OWNER) ===============
    async function loadAdmins() {
      const data = await apiGet('/api/admins');
      const tbody = document.getElementById('adminsTable');
      allAdmins = data.admins || [];

      if (data.success && data.admins.length > 0) {
        tbody.innerHTML = data.admins.map(a => `
          <tr>
            <td>${a.username}</td>
            <td><span class="badge badge-primary">${getRoleDisplay(a.role)}</span></td>
            <td>${formatPermissions(a.permissions)}</td>
            <td>
              ${a.role !== 'owner' ? `
                <button class="btn btn-sm btn-secondary" onclick='editAdmin(${JSON.stringify(a).replace(/'/g, "\\'")})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${a.id}')">‡∏•‡∏ö</button>
              ` : '<span class="text-muted">-</span>'}
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }

    function formatPermissions(perms) {
      if (!perms || Object.keys(perms).length === 0) return '-';
      const labels = {
        canBuyWithoutCommission: '‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°',
        canViewMainPassword: '‡∏î‡∏π‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•'
      };
      return Object.keys(perms)
        .filter(k => perms[k])
        .map(k => `<span class="badge badge-secondary">${labels[k] || k}</span>`)
        .join(' ');
    }

    function showAddAdminModal() {
      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', `
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="newAdminUsername" placeholder="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="newAdminPassword" placeholder="password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="newAdminRole">
            <option value="super_admin">Super Admin</option>
            <option value="admin">Admin</option>
            <option value="reseller">Reseller</option>
            <option value="customer">Customer</option>
          </select>
        </div>
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            <label class="permission-item">
              <input type="checkbox" id="permBuyStock"> ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addAdmin()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      `);
    }

    async function addAdmin() {
      const username = document.getElementById('newAdminUsername').value;
      const password = document.getElementById('newAdminPassword').value;
      const role = document.getElementById('newAdminRole').value;
      const permissions = {
        canBuyWithoutCommission: document.getElementById('permBuyStock').checked
      };

      if (!username || !password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }

      const data = await apiPost('/api/admins', { username, password, role, permissions });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    function editAdmin(admin) {
      showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', `
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="editAdminUsername" value="${admin.username}">
        </div>
        <div class="form-group">
          <label>Password (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
          <input type="text" class="form-control" id="editAdminPassword" placeholder="new password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="editAdminRole">
            <option value="super_admin" ${admin.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
            <option value="admin" ${admin.role === 'admin' ? 'selected' : ''}>Admin</option>
            <option value="reseller" ${admin.role === 'reseller' ? 'selected' : ''}>Reseller</option>
            <option value="customer" ${admin.role === 'customer' ? 'selected' : ''}>Customer</option>
          </select>
        </div>
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            <label class="permission-item">
              <input type="checkbox" id="editPermBuyStock" ${admin.permissions?.canBuyWithoutCommission ? 'checked' : ''}> ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="updateAdmin('${admin.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      `);
    }

    async function updateAdmin(id) {
      const username = document.getElementById('editAdminUsername').value;
      const password = document.getElementById('editAdminPassword').value;
      const role = document.getElementById('editAdminRole').value;
      const permissions = {
        canBuyWithoutCommission: document.getElementById('editPermBuyStock').checked
      };

      const data = await apiPut('/api/admins/' + id, {
        username,
        password: password || undefined,
        role,
        permissions
      });

      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteAdmin(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/admins/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== PACKAGES (OWNER) ===============
    let packagesData = [];

    async function loadPackages() {
      const data = await apiGet('/api/packages');
      packagesData = data.packages || [];
      renderPackagesTable();
    }

    function renderPackagesTable() {
      const tbody = document.getElementById('packagesTable');
      tbody.innerHTML = packagesData.map((pkg, i) => `
        <tr>
          <td><input type="text" class="form-control" value="${pkg.name}" onchange="updatePackageField(${i}, 'name', this.value)"></td>
          <td><input type="number" class="form-control" value="${pkg.days}" onchange="updatePackageField(${i}, 'days', parseInt(this.value))" style="width:80px;"></td>
          <td><input type="number" class="form-control" value="${pkg.resellerPrice || pkg.price || 0}" onchange="updatePackageField(${i}, 'resellerPrice', parseInt(this.value))" style="width:100px;"></td>
          <td><input type="number" class="form-control" value="${pkg.customerPrice || pkg.price || 0}" onchange="updatePackageField(${i}, 'customerPrice', parseInt(this.value))" style="width:100px;"></td>
          <td><input type="checkbox" ${pkg.active ? 'checked' : ''} onchange="updatePackageField(${i}, 'active', this.checked)"></td>
          <td><button class="btn btn-sm btn-danger" onclick="removePackageRow(${i})">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }

    function updatePackageField(index, field, value) {
      packagesData[index][field] = value;
      // Sync resellerPrice to price for backwards compatibility
      if (field === 'resellerPrice') {
        packagesData[index].price = value;
      }
    }

    function addPackageRow() {
      packagesData.push({ name: '', days: 30, resellerPrice: 500, customerPrice: 799, active: true });
      renderPackagesTable();
    }

    function removePackageRow(index) {
      packagesData.splice(index, 1);
      renderPackagesTable();
    }

    async function savePackages() {
      const data = await apiPost('/api/packages', { packages: packagesData });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== COMMISSIONS (OWNER) ===============
    async function loadCommissions() {
      const data = await apiGet('/api/commissions');

      if (data.success) {
        // Header
        const headerTh = document.getElementById('commissionPackageHeaders');
        headerTh.outerHTML = data.packages.map(p => `<th>${p.name} (${p.days}‡∏ß‡∏±‡∏ô)</th>`).join('');

        // Body
        const tbody = document.getElementById('commissionsTable');
        tbody.innerHTML = data.admins.map(admin => `
          <tr>
            <td>${admin.username}</td>
            <td><span class="badge badge-primary">${getRoleDisplay(admin.role)}</span></td>
            ${data.packages.map(p => `
              <td>
                <input type="number" class="commission-input"
                       value="${admin.commissions[p.days] || 0}"
                       data-admin="${admin.id}" data-days="${p.days}"
                       onchange="markCommissionChanged(this)">
              </td>
            `).join('')}
            <td>
              <button class="btn btn-sm btn-success" onclick="saveAdminCommission('${admin.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </td>
          </tr>
        `).join('');
      }
    }

    function markCommissionChanged(input) {
      input.style.borderColor = 'var(--warning)';
    }

    async function saveAdminCommission(adminId) {
      const inputs = document.querySelectorAll(`input[data-admin="${adminId}"]`);
      const commissions = {};
      inputs.forEach(input => {
        commissions[input.dataset.days] = parseInt(input.value) || 0;
        input.style.borderColor = '';
      });

      const data = await apiPut('/api/commissions/' + adminId, { commissions });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== ALL TRANSACTIONS (OWNER) ===============
    async function loadAllTransactions() {
      const filter = document.getElementById('filterReseller').value;
      const data = await apiGet('/api/reseller/transactions');

      // Populate filter dropdown
      if (data.success) {
        const resellers = [...new Set(data.transactions.map(t => t.resellerName))];
        const filterSelect = document.getElementById('filterReseller');
        if (filterSelect.options.length <= 1) {
          resellers.forEach(r => {
            filterSelect.innerHTML += `<option value="${r}">${r}</option>`;
          });
        }

        let transactions = data.transactions;
        if (filter) {
          transactions = transactions.filter(t => t.resellerName === filter);
        }

        const tbody = document.getElementById('allTransactionsTable');
        if (transactions.length > 0) {
          tbody.innerHTML = transactions.map(t => `
            <tr>
              <td>${t.resellerName}</td>
              <td><code>${t.subEmail}</code></td>
              <td>${t.packageDays} ‡∏ß‡∏±‡∏ô</td>
              <td>‡∏ø${t.amount.toLocaleString()}</td>
              <td><span class="badge ${t.status === 'paid' ? 'badge-success' : 'badge-danger'}">${t.status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}</span></td>
              <td>${formatDate(t.createdAt)}</td>
              <td>
                ${t.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="markTxnPaid('${t.id}')">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>` : '-'}
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        }
      }
    }

    async function markTxnPaid(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß?')) return;

      const data = await apiPut('/api/reseller/transactions/' + id + '/paid');
      if (data.success) {
        showToast(data.message, 'success');
        loadAllTransactions();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== SETTINGS (OWNER) ===============
    async function loadSettings() {
      const data = await apiGet('/api/settings');
      if (data.success) {
        document.getElementById('telegramBotToken').value = data.settings.telegramBotToken || '';
        document.getElementById('telegramChatId').value = data.settings.telegramChatId || '';
        document.getElementById('notifyDaysBefore').value = data.settings.notifyDaysBefore || 3;
      }
    }

    async function testTelegram() {
      const botToken = document.getElementById('telegramBotToken').value;
      const chatId = document.getElementById('telegramChatId').value;

      if (!botToken || !chatId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Bot Token ‡πÅ‡∏•‡∏∞ Chat ID', 'warning');
        return;
      }

      const data = await apiPost('/api/telegram/test', { botToken, chatId });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    async function saveSettings() {
      const data = await apiPut('/api/settings', {
        telegramBotToken: document.getElementById('telegramBotToken').value,
        telegramChatId: document.getElementById('telegramChatId').value,
        notifyDaysBefore: document.getElementById('notifyDaysBefore').value
      });

      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== HELPERS ===============
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      const dateOptions = { day: 'numeric', month: 'short', year: 'numeric', timeZone: 'Asia/Bangkok' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Bangkok' };
      const datePart = d.toLocaleDateString('th-TH', dateOptions);
      const timePart = d.toLocaleTimeString('th-TH', timeOptions);
      return `${datePart} ${timePart} ‡∏ô.`;
    }

    function logout() {
      localStorage.removeItem('ultra_token');
      localStorage.removeItem('ultra_user');
      window.location.href = '/';
    }

    // =============== SEND TELEGRAM REPORT ===============
    async function sendStockReport() {
      if (!window.mainEmailStats || !window.dashboardStats) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
      }

      const data = await apiPost('/api/send-stock-report', {
        mainEmailStats: window.mainEmailStats,
        dashboardStats: window.dashboardStats
      });

      if (data.success) {
        showToast('‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÑ‡∏õ Telegram ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } else {
        showToast(data.error || '‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    function showPurchaseResult(orders) {
      const resultHtml = `
        <div style="text-align:center;margin-bottom:20px;">
          <div style="font-size:3rem;">‚úÖ</div>
          <h3>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${orders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
        </div>
        <div style="background:var(--dark);padding:15px;border-radius:8px;">
          ${orders.map((o, i) => `
            <div style="padding:10px;margin-bottom:8px;background:var(--card);border-radius:6px;">
              <div><strong>${i + 1}.</strong> <code>${o.email}</code></div>
              <div style="color:var(--text-muted);font-size:0.9rem;">Password: <code>${o.password}</code></div>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-primary btn-block mt-20" onclick="copyPurchaseResult()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      `;
      window.lastPurchaseOrders = orders;
      showModal('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠', resultHtml);
    }

    function copyPurchaseResult() {
      const text = window.lastPurchaseOrders.map((o, i) =>
        `${i + 1}.\nEmail: ${o.email}\nPassword: ${o.password}`
      ).join('\n\n');
      navigator.clipboard.writeText(text).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!', 'success'));
    }

    function previewSlip(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = e => {
          document.getElementById('slipPreviewImg').src = e.target.result;
          document.getElementById('slipPreview').style.display = 'block';
        };
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function submitResellerPayment() {
      const fileInput = document.getElementById('slipImageInput');
      if (!fileInput.files || !fileInput.files[0]) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ', 'warning');
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(',')[1];

        const data = await apiPost('/api/reseller/submit-payment', {
          slipImage: base64
        }, '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ...');

        if (data.success) {
          showToast(data.message || '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
          loadSubmitPayment();
          // Clear file input
          fileInput.value = '';
          document.getElementById('slipPreview').style.display = 'none';
        } else {
          showToast(data.error, 'error');
        }
      };
      reader.readAsDataURL(fileInput.files[0]);
    }

    // =============== BANK SETTINGS ===============
    async function loadBankSettings() {
      const data = await apiGet('/api/bank-account');
      if (data.success && data.bankAccount) {
        document.getElementById('editBankName').value = data.bankAccount.bankName || '';
        document.getElementById('editBankAccountNumber').value = data.bankAccount.accountNumber || '';
        document.getElementById('editBankAccountName').value = data.bankAccount.accountName || '';
      }
    }

    async function saveBankSettings() {
      const bankName = document.getElementById('editBankName').value;
      const accountNumber = document.getElementById('editBankAccountNumber').value;
      const accountName = document.getElementById('editBankAccountName').value;

      const data = await apiPut('/api/bank-account', {
        bankName,
        accountNumber,
        accountName
      });

      if (data.success) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== INIT ===============
    loadDashboard();
  </script>
</body>
</html>
