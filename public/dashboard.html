<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ULTRA Stock - Dashboard</title>
  <link rel="icon" type="image/png" href="/images/logo.png">
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <button class="mobile-menu-btn" onclick="toggleSidebar()">Menu</button>

  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <img src="/images/logo.png" alt="ULTRA Stock" style="max-width: 100px; margin-bottom: 5px;">
        <div class="user-info">
          <div id="displayUsername">Loading...</div>
          <span class="user-role" id="displayRole">-</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Main</div>
          <a href="#" class="nav-link active" data-page="dashboard">
            <span class="icon">üìä</span> Dashboard
          </a>
          <a href="#" class="nav-link" data-page="buy">
            <span class="icon">üõí</span> ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="search">
            <span class="icon">üîç</span> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="history">
            <span class="icon">üìã</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠
          </a>
        </div>

        <div class="nav-section" id="navStockSection" style="display:none;">
          <div class="nav-section-title">Stock Management</div>
          <a href="#" class="nav-link" data-page="main-emails">
            <span class="icon">üìß</span> ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="stock">
            <span class="icon">üì¶</span> ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•
          </a>
          <a href="#" class="nav-link" data-page="expiring">
            <span class="icon">‚è∞</span> ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
          </a>
        </div>

        <div class="nav-section" id="navCommissionSection" style="display:none;">
          <div class="nav-section-title">Commission</div>
          <a href="#" class="nav-link" data-page="my-commission">
            <span class="icon">üí∞</span> ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô
          </a>
        </div>

        <div class="nav-section" id="navResellerSection" style="display:none;">
          <div class="nav-section-title">Reseller</div>
          <a href="#" class="nav-link" data-page="my-balance">
            <span class="icon">üí≥</span> ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞
          </a>
        </div>

        <div class="nav-section" id="navAdminSection" style="display:none;">
          <div class="nav-section-title">Admin (Owner Only)</div>
          <a href="#" class="nav-link" data-page="admins">
            <span class="icon">üë•</span> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
          </a>
          <a href="#" class="nav-link" data-page="packages">
            <span class="icon">üì¶</span> ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à
          </a>
          <a href="#" class="nav-link" data-page="commissions">
            <span class="icon">üíµ</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°
          </a>
          <a href="#" class="nav-link" data-page="all-transactions">
            <span class="icon">üìë</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô
          </a>
          <a href="#" class="nav-link" data-page="settings">
            <span class="icon">‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <button class="btn btn-secondary btn-block" onclick="logout()">
          Logout
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Page -->
      <div class="page" id="page-dashboard">
        <div class="page-header">
          <h2>Dashboard</h2>
          <p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö ULTRA Stock</p>
        </div>

        <div class="stats-grid" id="statsGrid">
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-value" id="statTotalSales">0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="stat-card success">
            <div class="stat-icon">üìà</div>
            <div class="stat-value" id="statMonthSales">0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-icon">üì¶</div>
            <div class="stat-value" id="statStock">0</div>
            <div class="stat-label">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
          </div>
          <div class="stat-card danger">
            <div class="stat-icon">‚è∞</div>
            <div class="stat-value" id="statExpiring">0</div>
            <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (7 ‡∏ß‡∏±‡∏ô)</div>
          </div>
        </div>

        <!-- My Stats (for non-owner) -->
        <div class="card" id="myStatsCard" style="display:none;">
          <div class="card-header">
            <h3>üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h3>
          </div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="statMySales">0</div>
                <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
              </div>
              <div class="stat-card success">
                <div class="stat-value" id="statMyMonthSales">0</div>
                <div class="stat-label">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
              </div>
              <div class="stat-card" id="myCommissionCard">
                <div class="stat-value" id="statMyCommission">‡∏ø0</div>
                <div class="stat-label">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Buy Page -->
      <div class="page hidden" id="page-buy">
        <div class="page-header">
          <h2>üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
          <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 300px; gap: 20px;">
          <!-- Stock List -->
          <div>
            <div class="card">
              <div class="card-header">
                <h3>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢</h3>
                <span class="badge badge-primary" id="stockCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
              </div>
              <div class="card-body">
                <div class="stock-grid" id="stockList">
                  <div class="loading"><div class="spinner"></div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Buy Panel -->
          <div class="buy-panel">
            <h3>üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h3>

            <div class="text-center mb-20">
              <div class="selected-count" id="selectedCount">0</div>
              <div class="text-muted">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            </div>

            <div class="form-group">
              <label>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</label>
              <div class="package-options" id="packageOptions">
                <!-- Dynamic -->
              </div>
            </div>

            <div class="form-group">
              <label>‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
              <input type="text" class="form-control" id="customerName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
            </div>

            <div class="buy-buttons">
              <button class="btn btn-primary btn-block" onclick="buyDirect()">
                üõí ‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°)
              </button>
              <button class="btn btn-secondary btn-block" id="btnBuyStock" onclick="buyStock()">
                üì¶ ‡∏ã‡∏∑‡πâ‡∏≠‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°)
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Search Page -->
      <div class="page hidden" id="page-search">
        <div class="page-header">
          <h2>üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
          <p>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</p>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="search-box">
              <input type="text" class="form-control" id="searchEmail" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
              <button class="btn btn-primary" onclick="searchSubEmail()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>

            <div id="searchResult" style="display:none;">
              <!-- Search result will appear here -->
            </div>
          </div>
        </div>
      </div>

      <!-- History Page -->
      <div class="page hidden" id="page-history">
        <div class="page-header">
          <h2>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏õ</p>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                    <th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  </tr>
                </thead>
                <tbody id="historyTable">
                  <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Emails Page -->
      <div class="page hidden" id="page-main-emails">
        <div class="page-header flex-between">
          <div>
            <h2>üìß ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</h2>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•‡∏´‡∏•‡∏±‡∏Å</p>
          </div>
          <button class="btn btn-primary" onclick="showAddMainEmailModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Email</th>
                    <th>Password</th>
                    <th>Slots</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="mainEmailsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock Page -->
      <div class="page hidden" id="page-stock">
        <div class="page-header flex-between">
          <div>
            <h2>üì¶ ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</h2>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
          </div>
          <button class="btn btn-primary" onclick="showAddStockModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>Password</th>
                    <th>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="stockTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Expiring Page -->
      <div class="page hidden" id="page-expiring">
        <div class="page-header">
          <h2>‚è∞ ‡πÄ‡∏°‡∏•‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô</p>
        </div>

        <div id="expiringContent">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- My Commission Page -->
      <div class="page hidden" id="page-my-commission">
        <div class="page-header">
          <h2>üí∞ ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <div class="card mb-20">
          <div class="card-header">
            <h3>‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</h3>
            <select class="form-control" style="width:auto;" id="commissionMonth" onchange="loadMyCommission()">
              <!-- Dynamic months -->
            </select>
          </div>
          <div class="card-body">
            <div class="stat-card">
              <div class="stat-value text-success" id="totalCommission">‡∏ø0</div>
              <div class="stat-label">‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  </tr>
                </thead>
                <tbody id="commissionTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- My Balance Page (Reseller) -->
      <div class="page hidden" id="page-my-balance">
        <div class="page-header">
          <h2>üí≥ ‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</h2>
          <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
        </div>

        <div class="stats-grid mb-20">
          <div class="stat-card danger">
            <div class="stat-value" id="balancePending">‡∏ø0</div>
            <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
          </div>
          <div class="stat-card success">
            <div class="stat-value" id="balancePaid">‡∏ø0</div>
            <div class="stat-label">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                  </tr>
                </thead>
                <tbody id="balanceTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Admins Page (Owner) -->
      <div class="page hidden" id="page-admins">
        <div class="page-header flex-between">
          <div>
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h2>
            <p>‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Admin ‡πÅ‡∏•‡∏∞ Reseller</p>
          </div>
          <button class="btn btn-primary" onclick="showAddAdminModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Permissions</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="adminsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Packages Page (Owner) -->
      <div class="page hidden" id="page-packages">
        <div class="page-header flex-between">
          <div>
            <h2>üì¶ ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</h2>
            <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</p>
          </div>
          <button class="btn btn-primary" onclick="addPackageRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</th>
                    <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤ (Reseller)</th>
                    <th>Active</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="packagesTable">
                  <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
            <div class="mt-20">
              <button class="btn btn-success" onclick="savePackages()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Commissions Page (Owner) -->
      <div class="page hidden" id="page-commissions">
        <div class="page-header">
          <h2>üíµ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏°‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô</h2>
          <p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Admin</p>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Admin</th>
                    <th>Role</th>
                    <th id="commissionPackageHeaders"><!-- Dynamic --></th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="commissionsTable">
                  <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- All Transactions Page (Owner) -->
      <div class="page hidden" id="page-all-transactions">
        <div class="page-header">
          <h2>üìë ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô</h2>
          <p>‡∏¢‡∏≠‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏ó‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>Filter</h3>
            <select class="form-control" style="width:auto;" id="filterReseller" onchange="loadAllTransactions()">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
              <!-- Dynamic -->
            </select>
          </div>
          <div class="card-body">
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Reseller</th>
                    <th>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•</th>
                    <th>‡πÅ‡∏û‡πá‡∏Å</th>
                    <th>‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="allTransactionsTable">
                  <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Page (Owner) -->
      <div class="page hidden" id="page-settings">
        <div class="page-header">
          <h2>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <p>Telegram Notification ‡πÅ‡∏•‡∏∞‡∏≠‡∏∑‡πà‡∏ô‡πÜ</p>
        </div>

        <div class="card">
          <div class="card-header">
            <h3>üì± Telegram Notification</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label>Bot Token</label>
              <input type="text" class="form-control" id="telegramBotToken" placeholder="123456789:ABCdefGHI...">
              <small class="text-muted">‡∏™‡∏£‡πâ‡∏≤‡∏á Bot ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà @BotFather</small>
            </div>
            <div class="form-group">
              <label>Chat ID</label>
              <input type="text" class="form-control" id="telegramChatId" placeholder="-1001234567890">
              <small class="text-muted">‡∏´‡∏≤ Chat ID ‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å @userinfobot</small>
            </div>
            <div class="form-group">
              <label>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤ (‡∏ß‡∏±‡∏ô)</label>
              <input type="number" class="form-control" id="notifyDaysBefore" value="3" min="1" max="7">
            </div>
            <div class="flex gap-10">
              <button class="btn btn-secondary" onclick="testTelegram()">üîî ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
              <button class="btn btn-success" onclick="saveSettings()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modals -->
  <div class="modal-overlay hidden" id="modalOverlay">
    <div class="modal" id="modalContent">
      <!-- Dynamic modal content -->
    </div>
  </div>

  <script>
    // =============== GLOBAL STATE ===============
    const API_URL = '';
    const token = localStorage.getItem('ultra_token');
    const user = JSON.parse(localStorage.getItem('ultra_user') || '{}');

    let packages = [];
    let selectedSubEmails = [];
    let selectedPackage = null;
    let allAdmins = [];

    // =============== AUTH CHECK ===============
    if (!token) {
      window.location.href = '/';
    }

    // Setup UI based on role
    document.getElementById('displayUsername').textContent = user.username || '-';
    document.getElementById('displayRole').textContent = getRoleDisplay(user.role);

    function getRoleDisplay(role) {
      const roles = {
        'owner': 'Owner',
        'super_admin': 'Super Admin',
        'admin': 'Admin',
        'reseller': 'Reseller'
      };
      return roles[role] || role;
    }

    // Show/hide navigation based on role
    if (user.role === 'owner' || user.role === 'super_admin') {
      document.getElementById('navStockSection').style.display = 'block';
    }
    if (user.role === 'owner' || user.role === 'super_admin' || user.role === 'admin') {
      document.getElementById('navCommissionSection').style.display = 'block';
    }
    if (user.role === 'reseller') {
      document.getElementById('navResellerSection').style.display = 'block';
    }
    if (user.role === 'owner') {
      document.getElementById('navAdminSection').style.display = 'block';
    }

    // Check permission for buy without commission
    const canBuyStock = user.role === 'owner' || user.role === 'super_admin' ||
      (user.permissions && user.permissions.canBuyWithoutCommission);
    if (!canBuyStock) {
      document.getElementById('btnBuyStock').style.display = 'none';
    }

    // =============== NAVIGATION ===============
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const page = link.dataset.page;
        navigateTo(page);
      });
    });

    function navigateTo(page) {
      document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[data-page="${page}"]`).classList.add('active');

      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById('page-' + page).classList.remove('hidden');

      // Load page data
      switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'buy': loadBuyPage(); break;
        case 'search': break;
        case 'history': loadHistory(); break;
        case 'main-emails': loadMainEmails(); break;
        case 'stock': loadStockTable(); break;
        case 'expiring': loadExpiring(); break;
        case 'my-commission': loadMyCommission(); break;
        case 'my-balance': loadMyBalance(); break;
        case 'admins': loadAdmins(); break;
        case 'packages': loadPackages(); break;
        case 'commissions': loadCommissions(); break;
        case 'all-transactions': loadAllTransactions(); break;
        case 'settings': loadSettings(); break;
      }

      // Close mobile sidebar
      document.getElementById('sidebar').classList.remove('open');
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // =============== API HELPERS ===============
    async function apiGet(endpoint) {
      const response = await fetch(API_URL + endpoint, {
        headers: { 'Authorization': 'Bearer ' + token }
      });
      return response.json();
    }

    async function apiPost(endpoint, data) {
      const response = await fetch(API_URL + endpoint, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }

    async function apiPut(endpoint, data) {
      const response = await fetch(API_URL + endpoint, {
        method: 'PUT',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      });
      return response.json();
    }

    async function apiDelete(endpoint) {
      const response = await fetch(API_URL + endpoint, {
        method: 'DELETE',
        headers: { 'Authorization': 'Bearer ' + token }
      });
      return response.json();
    }

    // =============== TOAST ===============
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // =============== MODAL ===============
    function showModal(title, content) {
      document.getElementById('modalContent').innerHTML = `
        <div class="modal-header">
          <h3>${title}</h3>
          <button class="modal-close" onclick="hideModal()">&times;</button>
        </div>
        <div class="modal-body">${content}</div>
      `;
      document.getElementById('modalOverlay').classList.remove('hidden');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.add('hidden');
    }

    // =============== DASHBOARD ===============
    async function loadDashboard() {
      const data = await apiGet('/api/dashboard');
      if (data.success) {
        document.getElementById('statTotalSales').textContent = data.stats.totalSales || 0;
        document.getElementById('statMonthSales').textContent = data.stats.monthSales || 0;
        document.getElementById('statStock').textContent = data.stats.stockCount || 0;
        document.getElementById('statExpiring').textContent = data.stats.expiringCount || 0;

        // Show my stats for non-owner
        if (user.role !== 'owner') {
          document.getElementById('myStatsCard').style.display = 'block';
          document.getElementById('statMySales').textContent = data.stats.mySales || 0;
          document.getElementById('statMyMonthSales').textContent = data.stats.myMonthSales || 0;
          document.getElementById('statMyCommission').textContent = '‡∏ø' + (data.stats.myCommission || 0).toLocaleString();
        }

        // Hide commission for reseller
        if (user.role === 'reseller') {
          document.getElementById('myCommissionCard').style.display = 'none';
        }
      }
    }

    // =============== BUY PAGE ===============
    async function loadBuyPage() {
      // Load packages
      const pkgData = await apiGet('/api/packages');
      if (pkgData.success) {
        packages = pkgData.packages.filter(p => p.active);
        renderPackageOptions();
      }

      // Load stock
      const stockData = await apiGet('/api/sub-emails?status=stock');
      if (stockData.success) {
        document.getElementById('stockCount').textContent = stockData.emails.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        renderStockList(stockData.emails);
      }
    }

    function renderPackageOptions() {
      const container = document.getElementById('packageOptions');
      container.innerHTML = packages.map(pkg => `
        <div class="package-option ${selectedPackage === pkg.days ? 'selected' : ''}"
             onclick="selectPackage(${pkg.days})">
          <div class="package-days">${pkg.days}</div>
          <div class="package-name">${pkg.name}</div>
        </div>
      `).join('');
    }

    function selectPackage(days) {
      selectedPackage = days;
      renderPackageOptions();
    }

    function renderStockList(emails) {
      const container = document.getElementById('stockList');
      if (emails.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">üì¶</div><h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3></div>';
        return;
      }

      container.innerHTML = emails.map(email => `
        <div class="stock-item ${selectedSubEmails.includes(email.id) ? 'selected' : ''}"
             onclick="toggleStockItem('${email.id}')">
          <div class="stock-item-header">
            <input type="checkbox" ${selectedSubEmails.includes(email.id) ? 'checked' : ''}
                   onclick="event.stopPropagation(); toggleStockItem('${email.id}')">
            <span class="stock-email">${email.email}</span>
          </div>
          <div class="stock-password">Password: ${email.password}</div>
          <div class="stock-main-email">‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•: ${email.mainEmail}</div>
        </div>
      `).join('');
    }

    function toggleStockItem(id) {
      const index = selectedSubEmails.indexOf(id);
      if (index > -1) {
        selectedSubEmails.splice(index, 1);
      } else {
        selectedSubEmails.push(id);
      }
      document.getElementById('selectedCount').textContent = selectedSubEmails.length;
      loadBuyPage(); // Re-render
    }

    async function buyDirect() {
      await doBuy('direct');
    }

    async function buyStock() {
      await doBuy('stock');
    }

    async function doBuy(saleType) {
      if (selectedSubEmails.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', 'warning');
        return;
      }
      if (!selectedPackage) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à', 'warning');
        return;
      }

      const customerName = document.getElementById('customerName').value;

      const data = await apiPost('/api/orders', {
        subEmailIds: selectedSubEmails,
        packageDays: selectedPackage,
        customerName,
        saleType
      });

      if (data.success) {
        showToast(data.message, 'success');

        // Show result modal
        const resultHtml = `
          <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:3rem;">‚úÖ</div>
            <h3>‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${data.orders.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Email</th><th>Password</th><th>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</th></tr></thead>
              <tbody>
                ${data.orders.map(o => `
                  <tr>
                    <td><code>${o.email}</code></td>
                    <td>${o.password}</td>
                    <td>${formatDate(o.expiresAt)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
          <div class="mt-20 text-center">
            <button class="btn btn-secondary" onclick="copyOrders(${JSON.stringify(data.orders).replace(/"/g, '&quot;')})">üìã Copy ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
          </div>
        `;
        showModal('üéâ ‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', resultHtml);

        // Reset
        selectedSubEmails = [];
        document.getElementById('selectedCount').textContent = '0';
        document.getElementById('customerName').value = '';
        loadBuyPage();
      } else {
        showToast(data.error, 'error');
      }
    }

    function copyOrders(orders) {
      const text = orders.map(o => `${o.email}\n${o.password}`).join('\n\n');
      navigator.clipboard.writeText(text);
      showToast('Copied!', 'success');
    }

    // =============== SEARCH ===============
    async function searchSubEmail() {
      const email = document.getElementById('searchEmail').value;
      if (!email) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', 'warning');
        return;
      }

      const data = await apiGet('/api/sub-emails/search?email=' + encodeURIComponent(email));
      const resultDiv = document.getElementById('searchResult');

      if (data.success) {
        const r = data.result;
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
          <div class="card mt-20">
            <div class="card-header">
              <h3>üìß ${r.email}</h3>
              <span class="badge ${r.status === 'sold' ? 'badge-success' : 'badge-warning'}">${r.status}</span>
            </div>
            <div class="card-body">
              <p><strong>Password:</strong> ${r.password}</p>
              <hr style="margin:15px 0;border-color:var(--border);">
              <p><strong>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•:</strong> ${r.mainEmail ? r.mainEmail.email : '-'}</p>
              ${r.mainEmail && r.mainEmail.password ? `<p><strong>‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•:</strong> <code>${r.mainEmail.password}</code></p>` : ''}
              ${r.order ? `
                <hr style="margin:15px 0;border-color:var(--border);">
                <p><strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤:</strong> ${r.order.customerName || '-'}</p>
                <p><strong>‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏Å‡∏à:</strong> ${r.order.packageDays} ‡∏ß‡∏±‡∏ô</p>
                <p><strong>‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢:</strong> ${r.order.soldBy}</p>
                <p><strong>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${formatDate(r.order.expiresAt)}</p>
                <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="badge ${r.order.status === 'expired' ? 'badge-danger' : 'badge-success'}">${r.order.status}</span></p>
              ` : ''}
            </div>
          </div>
        `;
      } else {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<div class="empty-state mt-20"><div class="icon">üîç</div><h3>${data.error}</h3></div>`;
      }
    }

    // =============== HISTORY ===============
    async function loadHistory() {
      const data = await apiGet('/api/orders?filter=mine');
      const tbody = document.getElementById('historyTable');

      if (data.success && data.orders.length > 0) {
        tbody.innerHTML = data.orders.map(o => `
          <tr>
            <td><code>${o.subEmail}</code></td>
            <td>${o.customerName || '-'}</td>
            <td>${o.packageDays} ‡∏ß‡∏±‡∏ô</td>
            <td><span class="badge ${o.saleType === 'direct' ? 'badge-success' : 'badge-secondary'}">${o.saleType === 'direct' ? '‡∏Ç‡∏≤‡∏¢‡∏ï‡∏£‡∏á' : '‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å'}</span></td>
            <td>${formatDate(o.expiresAt)}</td>
            <td><span class="badge ${o.status === 'expired' ? 'badge-danger' : 'badge-success'}">${o.status}</span></td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>';
      }
    }

    // =============== MAIN EMAILS ===============
    async function loadMainEmails() {
      const data = await apiGet('/api/main-emails');
      const tbody = document.getElementById('mainEmailsTable');

      if (data.success && data.emails.length > 0) {
        tbody.innerHTML = data.emails.map(e => `
          <tr>
            <td><code>${e.email}</code></td>
            <td>${e.password}</td>
            <td>${e.usedSlots}/${e.capacity}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editMainEmail('${e.id}', '${e.email}', '${e.password}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
              <button class="btn btn-sm btn-danger" onclick="deleteMainEmail('${e.id}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</td></tr>';
      }
    }

    function showAddMainEmailModal() {
      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="newMainEmail" placeholder="main@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="newMainPassword" placeholder="password">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addMainEmail()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      `);
    }

    async function addMainEmail() {
      const email = document.getElementById('newMainEmail').value;
      const password = document.getElementById('newMainPassword').value;

      if (!email || !password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }

      const data = await apiPost('/api/main-emails', { email, password });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    function editMainEmail(id, email, password) {
      showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>Email</label>
          <input type="email" class="form-control" id="editMainEmail" value="${email}">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="editMainPassword" value="${password}">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="updateMainEmail('${id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      `);
    }

    async function updateMainEmail(id) {
      const email = document.getElementById('editMainEmail').value;
      const password = document.getElementById('editMainPassword').value;

      const data = await apiPut('/api/main-emails/' + id, { email, password });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteMainEmail(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/main-emails/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadMainEmails();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== STOCK TABLE ===============
    async function loadStockTable() {
      const data = await apiGet('/api/sub-emails?status=stock');
      const tbody = document.getElementById('stockTable');

      if (data.success && data.emails.length > 0) {
        tbody.innerHTML = data.emails.map(e => `
          <tr>
            <td><code>${e.email}</code></td>
            <td>${e.password}</td>
            <td>${e.mainEmail}</td>
            <td><span class="badge badge-warning">${e.status}</span></td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteSubEmail('${e.id}')">‡∏•‡∏ö</button>
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å</td></tr>';
      }
    }

    async function showAddStockModal() {
      // Load main emails
      const mainData = await apiGet('/api/main-emails');

      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', `
        <div class="form-group">
          <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•</label>
          <select class="form-control" id="stockMainEmailId">
            ${mainData.emails.map(e => `<option value="${e.id}">${e.email} (${e.usedSlots}/${e.capacity})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏• (email:password ‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î)</label>
          <textarea class="form-control" id="stockEmails" rows="6" placeholder="sub1@example.com:password1
sub2@example.com:password2"></textarea>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addStock()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
        </div>
      `);
    }

    async function addStock() {
      const mainEmailId = document.getElementById('stockMainEmailId').value;
      const emailsText = document.getElementById('stockEmails').value;

      const emails = emailsText.split('\n')
        .map(line => line.trim())
        .filter(line => line.includes(':'))
        .map(line => {
          const [email, password] = line.split(':');
          return { email: email.trim(), password: password.trim() };
        });

      if (emails.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•', 'warning');
        return;
      }

      const data = await apiPost('/api/sub-emails', { mainEmailId, emails });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadStockTable();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteSubEmail(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ã‡∏±‡∏ö‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/sub-emails/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadStockTable();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== EXPIRING ===============
    async function loadExpiring() {
      const data = await apiGet('/api/expiring?days=7');
      const container = document.getElementById('expiringContent');

      if (data.success) {
        const { today, soon, upcoming } = data.expiring;

        if (today.length === 0 && soon.length === 0 && upcoming.length === 0) {
          container.innerHTML = '<div class="empty-state"><div class="icon">‚úÖ</div><h3>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</h3></div>';
          return;
        }

        container.innerHTML = `
          ${renderExpirySection('today', '‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ', today)}
          ${renderExpirySection('soon', '‡∏´‡∏°‡∏î‡πÉ‡∏ô 1-3 ‡∏ß‡∏±‡∏ô', soon)}
          ${renderExpirySection('upcoming', '‡∏´‡∏°‡∏î‡πÉ‡∏ô 4-7 ‡∏ß‡∏±‡∏ô', upcoming)}
        `;
      }
    }

    function renderExpirySection(type, title, items) {
      if (items.length === 0) return '';

      return `
        <div class="expiry-section">
          <div class="expiry-section-header ${type}">
            <span>${type === 'today' ? 'üî¥' : type === 'soon' ? 'üü†' : 'üü°'}</span>
            <h4>${title}</h4>
            <span class="expiry-count">${items.length}</span>
          </div>
          ${items.map(item => `
            <div class="expiry-card">
              <div class="expiry-card-header">
                <span class="expiry-email">${item.subEmail}</span>
                <span class="expiry-${type}">${item.daysUntil <= 0 ? '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß!' : item.daysUntil + ' ‡∏ß‡∏±‡∏ô'}</span>
              </div>
              <div class="expiry-card-body">
                <div>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${item.customerName || '-'}</div>
                <div>‡πÅ‡∏û‡πá‡∏Å: ${item.packageDays} ‡∏ß‡∏±‡∏ô</div>
                <div>‡∏Ç‡∏≤‡∏¢‡πÇ‡∏î‡∏¢: ${item.soldBy}</div>
                <div>‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏: ${formatDate(item.expiresAt)}</div>
                ${item.mainEmail ? `<div>‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•: ${item.mainEmail.email}</div>` : ''}
                ${item.mainEmail && item.mainEmail.password ? `<div>‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•: <code>${item.mainEmail.password}</code></div>` : ''}
              </div>
              <div class="expiry-card-actions">
                <button class="btn btn-sm btn-warning" onclick="showExtendModal('${item.id}')">‚ûï ‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
                <button class="btn btn-sm btn-danger" onclick="markExpired('${item.id}')">üóëÔ∏è ‡∏•‡∏ö (‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß)</button>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function showExtendModal(orderId) {
      showModal('‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏', `
        <div class="form-group">
          <label>‡∏ï‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° (‡∏ß‡∏±‡∏ô)</label>
          <input type="number" class="form-control" id="extendDays" value="30" min="1">
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-success" onclick="extendOrder('${orderId}')">‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏</button>
        </div>
      `);
    }

    async function extendOrder(orderId) {
      const days = parseInt(document.getElementById('extendDays').value);
      if (!days || days < 1) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô', 'warning');
        return;
      }

      const data = await apiPut('/api/orders/' + orderId + '/extend', { days });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadExpiring();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function markExpired(orderId) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ? (‡πÄ‡∏°‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö)')) return;

      const data = await apiPut('/api/orders/' + orderId + '/expire');
      if (data.success) {
        showToast(data.message, 'success');
        loadExpiring();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== MY COMMISSION ===============
    function loadMyCommission() {
      // Setup month selector
      const select = document.getElementById('commissionMonth');
      if (select.options.length === 0) {
        const now = new Date();
        for (let i = 0; i < 6; i++) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const value = d.toISOString().substring(0, 7);
          const label = d.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
          select.innerHTML += `<option value="${value}">${label}</option>`;
        }
      }

      loadCommissionData();
    }

    async function loadCommissionData() {
      const month = document.getElementById('commissionMonth').value;
      const data = await apiGet('/api/commission-log?month=' + month);

      if (data.success) {
        document.getElementById('totalCommission').textContent = '‡∏ø' + data.total.toLocaleString();

        const tbody = document.getElementById('commissionTable');
        if (data.logs.length > 0) {
          tbody.innerHTML = data.logs.map(log => `
            <tr>
              <td><code>${log.subEmail}</code></td>
              <td>${log.packageDays} ‡∏ß‡∏±‡∏ô</td>
              <td class="text-success">‡∏ø${log.amount.toLocaleString()}</td>
              <td>${formatDate(log.createdAt)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏°</td></tr>';
        }
      }
    }

    // =============== MY BALANCE (RESELLER) ===============
    async function loadMyBalance() {
      const balanceData = await apiGet('/api/reseller/balance');
      if (balanceData.success) {
        document.getElementById('balancePending').textContent = '‡∏ø' + balanceData.pending.toLocaleString();
        document.getElementById('balancePaid').textContent = '‡∏ø' + balanceData.paid.toLocaleString();
      }

      const txnData = await apiGet('/api/reseller/transactions');
      const tbody = document.getElementById('balanceTable');

      if (txnData.success && txnData.transactions.length > 0) {
        tbody.innerHTML = txnData.transactions.map(t => `
          <tr>
            <td><code>${t.subEmail}</code></td>
            <td>${t.packageDays} ‡∏ß‡∏±‡∏ô</td>
            <td>‡∏ø${t.amount.toLocaleString()}</td>
            <td><span class="badge ${t.status === 'paid' ? 'badge-success' : 'badge-danger'}">${t.status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}</span></td>
            <td>${formatDate(t.createdAt)}</td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
      }
    }

    // =============== ADMINS (OWNER) ===============
    async function loadAdmins() {
      const data = await apiGet('/api/admins');
      const tbody = document.getElementById('adminsTable');
      allAdmins = data.admins || [];

      if (data.success && data.admins.length > 0) {
        tbody.innerHTML = data.admins.map(a => `
          <tr>
            <td>${a.username}</td>
            <td><span class="badge badge-primary">${getRoleDisplay(a.role)}</span></td>
            <td>${formatPermissions(a.permissions)}</td>
            <td>
              ${a.role !== 'owner' ? `
                <button class="btn btn-sm btn-secondary" onclick='editAdmin(${JSON.stringify(a).replace(/'/g, "\\'")})'>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${a.id}')">‡∏•‡∏ö</button>
              ` : '<span class="text-muted">-</span>'}
            </td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
      }
    }

    function formatPermissions(perms) {
      if (!perms || Object.keys(perms).length === 0) return '-';
      const labels = {
        canBuyWithoutCommission: '‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°',
        canViewMainPassword: '‡∏î‡∏π‡∏û‡∏≤‡∏™‡∏´‡∏±‡∏ß‡πÄ‡∏°‡∏•'
      };
      return Object.keys(perms)
        .filter(k => perms[k])
        .map(k => `<span class="badge badge-secondary">${labels[k] || k}</span>`)
        .join(' ');
    }

    function showAddAdminModal() {
      showModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', `
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="newAdminUsername" placeholder="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="text" class="form-control" id="newAdminPassword" placeholder="password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="newAdminRole">
            <option value="super_admin">Super Admin</option>
            <option value="admin">Admin</option>
            <option value="reseller">Reseller</option>
          </select>
        </div>
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            <label class="permission-item">
              <input type="checkbox" id="permBuyStock"> ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="addAdmin()">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        </div>
      `);
    }

    async function addAdmin() {
      const username = document.getElementById('newAdminUsername').value;
      const password = document.getElementById('newAdminPassword').value;
      const role = document.getElementById('newAdminRole').value;
      const permissions = {
        canBuyWithoutCommission: document.getElementById('permBuyStock').checked
      };

      if (!username || !password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'warning');
        return;
      }

      const data = await apiPost('/api/admins', { username, password, role, permissions });
      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    function editAdmin(admin) {
      showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', `
        <div class="form-group">
          <label>Username</label>
          <input type="text" class="form-control" id="editAdminUsername" value="${admin.username}">
        </div>
        <div class="form-group">
          <label>Password (‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô)</label>
          <input type="text" class="form-control" id="editAdminPassword" placeholder="new password">
        </div>
        <div class="form-group">
          <label>Role</label>
          <select class="form-control" id="editAdminRole">
            <option value="super_admin" ${admin.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
            <option value="admin" ${admin.role === 'admin' ? 'selected' : ''}>Admin</option>
            <option value="reseller" ${admin.role === 'reseller' ? 'selected' : ''}>Reseller</option>
          </select>
        </div>
        <div class="form-group">
          <label>Permissions</label>
          <div class="permissions-grid">
            <label class="permission-item">
              <input type="checkbox" id="editPermBuyStock" ${admin.permissions?.canBuyWithoutCommission ? 'checked' : ''}> ‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡∏Ñ‡∏≠‡∏°
            </label>
          </div>
        </div>
        <div class="modal-footer" style="padding:0;border:0;margin-top:20px;">
          <button class="btn btn-secondary" onclick="hideModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="btn btn-primary" onclick="updateAdmin('${admin.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
      `);
    }

    async function updateAdmin(id) {
      const username = document.getElementById('editAdminUsername').value;
      const password = document.getElementById('editAdminPassword').value;
      const role = document.getElementById('editAdminRole').value;
      const permissions = {
        canBuyWithoutCommission: document.getElementById('editPermBuyStock').checked
      };

      const data = await apiPut('/api/admins/' + id, {
        username,
        password: password || undefined,
        role,
        permissions
      });

      if (data.success) {
        showToast(data.message, 'success');
        hideModal();
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    async function deleteAdmin(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ?')) return;

      const data = await apiDelete('/api/admins/' + id);
      if (data.success) {
        showToast(data.message, 'success');
        loadAdmins();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== PACKAGES (OWNER) ===============
    let packagesData = [];

    async function loadPackages() {
      const data = await apiGet('/api/packages');
      packagesData = data.packages || [];
      renderPackagesTable();
    }

    function renderPackagesTable() {
      const tbody = document.getElementById('packagesTable');
      tbody.innerHTML = packagesData.map((pkg, i) => `
        <tr>
          <td><input type="text" class="form-control" value="${pkg.name}" onchange="updatePackageField(${i}, 'name', this.value)"></td>
          <td><input type="number" class="form-control" value="${pkg.days}" onchange="updatePackageField(${i}, 'days', parseInt(this.value))"></td>
          <td><input type="number" class="form-control" value="${pkg.price}" onchange="updatePackageField(${i}, 'price', parseInt(this.value))"></td>
          <td><input type="checkbox" ${pkg.active ? 'checked' : ''} onchange="updatePackageField(${i}, 'active', this.checked)"></td>
          <td><button class="btn btn-sm btn-danger" onclick="removePackageRow(${i})">‡∏•‡∏ö</button></td>
        </tr>
      `).join('');
    }

    function updatePackageField(index, field, value) {
      packagesData[index][field] = value;
    }

    function addPackageRow() {
      packagesData.push({ name: '', days: 30, price: 500, active: true });
      renderPackagesTable();
    }

    function removePackageRow(index) {
      packagesData.splice(index, 1);
      renderPackagesTable();
    }

    async function savePackages() {
      const data = await apiPost('/api/packages', { packages: packagesData });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== COMMISSIONS (OWNER) ===============
    async function loadCommissions() {
      const data = await apiGet('/api/commissions');

      if (data.success) {
        // Header
        const headerTh = document.getElementById('commissionPackageHeaders');
        headerTh.outerHTML = data.packages.map(p => `<th>${p.name} (${p.days}‡∏ß‡∏±‡∏ô)</th>`).join('');

        // Body
        const tbody = document.getElementById('commissionsTable');
        tbody.innerHTML = data.admins.map(admin => `
          <tr>
            <td>${admin.username}</td>
            <td><span class="badge badge-primary">${getRoleDisplay(admin.role)}</span></td>
            ${data.packages.map(p => `
              <td>
                <input type="number" class="commission-input"
                       value="${admin.commissions[p.days] || 0}"
                       data-admin="${admin.id}" data-days="${p.days}"
                       onchange="markCommissionChanged(this)">
              </td>
            `).join('')}
            <td>
              <button class="btn btn-sm btn-success" onclick="saveAdminCommission('${admin.id}')">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </td>
          </tr>
        `).join('');
      }
    }

    function markCommissionChanged(input) {
      input.style.borderColor = 'var(--warning)';
    }

    async function saveAdminCommission(adminId) {
      const inputs = document.querySelectorAll(`input[data-admin="${adminId}"]`);
      const commissions = {};
      inputs.forEach(input => {
        commissions[input.dataset.days] = parseInt(input.value) || 0;
        input.style.borderColor = '';
      });

      const data = await apiPut('/api/commissions/' + adminId, { commissions });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== ALL TRANSACTIONS (OWNER) ===============
    async function loadAllTransactions() {
      const filter = document.getElementById('filterReseller').value;
      const data = await apiGet('/api/reseller/transactions');

      // Populate filter dropdown
      if (data.success) {
        const resellers = [...new Set(data.transactions.map(t => t.resellerName))];
        const filterSelect = document.getElementById('filterReseller');
        if (filterSelect.options.length <= 1) {
          resellers.forEach(r => {
            filterSelect.innerHTML += `<option value="${r}">${r}</option>`;
          });
        }

        let transactions = data.transactions;
        if (filter) {
          transactions = transactions.filter(t => t.resellerName === filter);
        }

        const tbody = document.getElementById('allTransactionsTable');
        if (transactions.length > 0) {
          tbody.innerHTML = transactions.map(t => `
            <tr>
              <td>${t.resellerName}</td>
              <td><code>${t.subEmail}</code></td>
              <td>${t.packageDays} ‡∏ß‡∏±‡∏ô</td>
              <td>‡∏ø${t.amount.toLocaleString()}</td>
              <td><span class="badge ${t.status === 'paid' ? 'badge-success' : 'badge-danger'}">${t.status === 'paid' ? '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß' : '‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞'}</span></td>
              <td>${formatDate(t.createdAt)}</td>
              <td>
                ${t.status === 'pending' ? `<button class="btn btn-sm btn-success" onclick="markTxnPaid('${t.id}')">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</button>` : '-'}
              </td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>';
        }
      }
    }

    async function markTxnPaid(id) {
      if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß?')) return;

      const data = await apiPut('/api/reseller/transactions/' + id + '/paid');
      if (data.success) {
        showToast(data.message, 'success');
        loadAllTransactions();
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== SETTINGS (OWNER) ===============
    async function loadSettings() {
      const data = await apiGet('/api/settings');
      if (data.success) {
        document.getElementById('telegramBotToken').value = data.settings.telegramBotToken || '';
        document.getElementById('telegramChatId').value = data.settings.telegramChatId || '';
        document.getElementById('notifyDaysBefore').value = data.settings.notifyDaysBefore || 3;
      }
    }

    async function testTelegram() {
      const botToken = document.getElementById('telegramBotToken').value;
      const chatId = document.getElementById('telegramChatId').value;

      if (!botToken || !chatId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Bot Token ‡πÅ‡∏•‡∏∞ Chat ID', 'warning');
        return;
      }

      const data = await apiPost('/api/telegram/test', { botToken, chatId });
      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    async function saveSettings() {
      const data = await apiPut('/api/settings', {
        telegramBotToken: document.getElementById('telegramBotToken').value,
        telegramChatId: document.getElementById('telegramChatId').value,
        notifyDaysBefore: document.getElementById('notifyDaysBefore').value
      });

      if (data.success) {
        showToast(data.message, 'success');
      } else {
        showToast(data.error, 'error');
      }
    }

    // =============== HELPERS ===============
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return '-';
      return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function logout() {
      localStorage.removeItem('ultra_token');
      localStorage.removeItem('ultra_user');
      window.location.href = '/';
    }

    // =============== INIT ===============
    loadDashboard();
  </script>
</body>
</html>
